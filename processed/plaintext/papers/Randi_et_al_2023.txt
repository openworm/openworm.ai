Randi et al 2023

Generated from: https://www.nature.com/articles/s41586-023-06683-4

    Page 1

# Neural signal propagation atlas of Caenorhabditis elegans

Francesco Randi1,3, Anuj K. Sharma1, Sophie Dvali1 &#x26; Andrew M. Leifer1,2✉

Received: 15 July 2022

Accepted: 27 September 2023

Published online: 1 November 2023

Open access

Establishing how neural function emerges from network properties is a fundamental problem in neuroscience1. Here, to better understand the relationship between the structure and the function of a nervous system, we systematically measure signal propagation in 23,433 pairs of neurons across the head of the nematode *Caenorhabditis elegans* by direct optogenetic activation and simultaneous whole-brain calcium imaging. We measure the sign (excitatory or inhibitory), strength, temporal properties and causal direction of signal propagation between these neurons to create a functional atlas. We find that signal propagation differs from model predictions that are based on anatomy. Using mutants, we show that extrasynaptic signalling not visible from anatomy contributes to this difference. We identify many instances of dense-core-vesicle-dependent signalling, including on timescales of less than a second, that evoke acute calcium transients—often where no direct wired connection exists but where relevant neuropeptides and receptors are expressed. We propose that, in such cases, extrasynaptically released neuropeptides serve a similar function to that of classical neurotransmitters. Finally, our measured signal propagation atlas better predicts the neural dynamics of spontaneous activity than do models based on anatomy. We conclude that both synaptic and extrasynaptic signalling drive neural dynamics on short timescales, and that measurements of evoked signal propagation are crucial for interpreting neural function.

Brain connectivity mapping is motivated by the claim that “nothing defines the function of a neuron more faithfully than the nature of its inputs and outputs”2. This approach to revealing neural function drives large-scale efforts to generate connectomes—anatomical maps of the synaptic contacts of the brain—in a diverse set of organisms, ranging from mice3 to *Platynereis4. The C. elegans* connectome1,5,6 is the most mature of these efforts, and has been used to reveal circuit-level mechanisms of sensorimotor processing7,8, to constrain models of neural dynamics9 and to make predictions of neural function10. Anatomy, however, omits key aspects of neurons’ inputs and outputs, or leaves them ambiguous: the strength and sign (excitatory or inhibitory) of a neural connection are not always evident from wiring or gene expression. Historically, this and related perturbative approaches have been called many names (Supplementary Information), but they all stand in contrast to correlative approaches that seek to infer neural function from activity correlations alone. Correlative approaches do not directly measure causality and are limited to finding relations among only those neurons that happen to be active. Perturbative approaches measure signal propagation directly, but previous efforts have been restricted to selected circuits or subregions of the brain, and have often achieved only cell-type and not single-cell resolution17–22.

Here we use neural activation to measure signal propagation between neurons throughout the head of *C. elegans* at single-cell resolution. We survey 23,433 pairs of neurons—the majority of the possible pairs in the head—to present a systematic atlas. We show that functional measurements better predict spontaneous activity than anatomy does.

| 1Department of Physics, Princeton University, Princeton, NJ, USA. | 2Princeton Neurosciences Institute, Princeton University, Princeton, NJ, USA. | 3Present address: Regeneron Pharmaceuticals, Tarrytown, NY, USA. |
| ----------------------------------------------------------------- | ----------------------------------------------------------------------------- | ---------------------------------------------------------------- |

406 | Nature | Vol 623 | 9 November 2023

    Page 2

# Measuring neural activation and network response

a,b, Schematics of the instrument (a) and the experiment (b). c, NeuroPAL fluorophores for neural identification. d, Whole-brain cell-resolved calcium activity (GCaMP6s fluorescence normalized by noise) during stimulation of individual neurons. e, Paired activity of AVJR and AVDR in response to AVJR stimulation, shown as relative change (ΔF/F₀) across trials and animals. Bottom, simultaneously recorded paired activity for individual trials (sorted by mean AVDR activity). All trials are shown that elicited activity. f, Same as e for AVER stimulation and AVAR response. g, Same as e for SAADL stimulation and OLLR response.

A stimulation was delivered once every 30 s; grey lines indicate those instances when the stimuli were delivered on-target. The targeted neurons are listed at the top.

and that peptidergic extrasynaptic signalling contributes to neural dynamics by performing a functional role similar to that of a classical neurotransmitter.

Population imaging and single-cell activation

To measure signal propagation, we activated each single neuron, one by one, through two-photon stimulation, while simultaneously recording the calcium activity of the population at cellular resolution using spinning disk confocal microscopy (Fig. 1). We recorded activity from 113 wild-type (WT)-background animals, each for up to 40 min, while stimulating a mostly randomly selected sequence of neurons one by one every 30 s. We spatially restricted our two-photon activation in three dimensions to be the size of a typical C. elegans neuron, to minimize off-target activation of neighbouring neurons (Extended Data Fig. 2a,c–e,i,j and Supplementary Information).

Nature | Vol 623 | 9 November 2023 | 407

    Page 3

Article

immobilized but awake, and pharyngeal pumping was visible during recordings. To overcome the challenges associated with spectral overlap between the actuator and the indicator, we used TWISP—a transgenic worm for interrogating signal propagation 23, which expresses a purple-light actuator, GUR-3/PRDX-2 (refs. 24,25) and a nuclear-localized calcium indicator GCaMP6s (ref. 26) in each neuron (Fig. 1b and Extended Data Fig. 2b), along with fluorophores for neural identification from NeuroPAL (ref. 27) (Fig. 1c). Validation of the GUR-3/PRDX-2 system is discussed in the Supplementary Information (see also Extended Data Fig. 2h and Supplementary Video 1). A drug-inducible gene-expression system was used to avoid toxicity during development, resulting in animals that were viable but still significantly less active than WT animals²³ (see Methods). A stimulus duration of 0.3 s or 0.5 s was chosen to evoke modest calcium responses (Extended Data Fig. 2f), similar in amplitude to those evoked naturally by odour stimuli²⁸.

Many neurons exhibited calcium activity in response to the activation of one or more other neurons (Fig. 1d). A downstream neuron’s response to a stimulated neuron is evidence that a signal propagated from the stimulated neuron to the downstream neuron.

We highlight three examples from the motor circuit (Fig. 1e–g). Stimulation of the interneuron AVJR evoked activity in AVDR (Fig. 1e). AVJ had been predicted to coordinate locomotion after egg-laying by promoting forward movements²⁹. The activity of AVD is associated with sensory-evoked (but not spontaneous) backward locomotion, and AVD receives chemical and electrical synaptic input from AVJ1,6. Therefore, both wiring and our functional measurements suggest that AVJ has a role in coordinating backward locomotion, in addition to its previously described roles in egg-laying and forward locomotion.

Activation of the premotor interneuron AVER evoked activity transients in AVAR (Fig. 1f). Both AVA31–35 (Extended Data Fig. 2h) and AVE are implicated in backward movement. Their activities are correlated, and AVE makes gap-junction and many chemical synaptic contacts with AVA1,6.

Activation of the turning-associated neuron SAADL³⁶ inhibited the activity of the sensory neuron OLLR. SAAD had been predicted to inhibit OLL, on the basis of gene-expression measurements. SAAD is cholinergic and it makes chemical synapses to OLL, which expresses an acetylcholine-gated chloride channel, LGC-47 (refs. 6,38,39). Other examples consistent with the literature are reported in Extended Data Table 1.

# Signal propagation map

We generated a signal propagation map by aggregating downstream responses to stimulation from 113 C. elegans individuals (Fig. 2a). We report the mean calcium response in a 30-s time window averaged across trials and animals (Extended Data Fig. 3a). We imaged activity in response to stimulation for 23,433 pairs of neurons (66% of all possible pairs in the head). Measured pairs were imaged at least once, and some as many as 59 times (Extended Data Figs. 3b and 4a). This includes activity from 186 of 188 neurons in the head, or 99% of all head neurons.

We developed a statistical framework, described in the Methods, to identify neuron pairs that can be deemed ‘functionally connected’ (q &#x3C; 0.05; Extended Data Fig. 4b), ‘functionally non-connected’ (qeq &#x3C; 0.05; Extended Data Fig. 5b) or for which we lack the confidence to make either determination. The statistical framework is conservative and requires consistent and reliable responses (or non-responses) compared to an empirical null distribution, considering effect size, sample size and multiple-hypothesis testing⁴⁰ to make either determination. Many neuron pairs fail to pass either statistical test, even though they often contain neural activity that, when observed in isolation, could easily be classified as a response (for example, AVJR→ASGR in Extended Data Fig. 4c).

Some variability in the downstream response can be attributed to variability in the upstream neuron’s response to its own stimulation, called its autoresponse. To study the variability of signal propagation excluding variability from the autoresponse, we calculated a kernel for each stimulation that evoked a downstream response. The kernel gives the activity of the downstream neuron when convolved with the activity of the upstream neuron. The kernel describes how the signal is transformed from upstream to downstream neuron for that stimulus event, including the timescales of the signal transfer (Extended Data Fig. 6b,c). We characterized the variability of each functional connection by comparing how these kernels transform a standard stimulus (Extended Data Fig. 6e). Kernels for many neuron pairs varied across trials and animals, presumably because of state- and history-dependent effects⁴⁵, including from neuromodulation16,46, plasticity and interanimal variability in wiring and expression. As expected, kernels from one neuron pair were more similar to each other than to kernels from other pairs (Extended Data Fig. 6f).

Functional measurements differ from anatomy. We observed an apparent contradiction with the wiring diagram—a large fraction of neuron pairs with monosynaptic (single-hop) wired connections are deemed functionally non-connected in our.

408 | Nature | Vol 623 | 9 November 2023

    Page 4

# Signal propagation map of C. elegans

| a             | ADEL    | ADER           | >0.4          |      |
| ------------- | ------- | -------------- | ------------- | ---- |
| ADFL          | ADLL    | ADLR           | AFDL          |      |
| AFDR          | AQR     | ASEL           | ASER          |      |
| ASGL          | ASGR    | ASHL           | ASHR          | 0.3  |
| ASIL          | ASIR    | ASJL           | ASJR          |      |
| ASKL          | ASKR    | AUAL           | AUAR          |      |
| AVG           | AWAL    | AWAR           | AWBL          |      |
| AWBR          | AWCL    | 0.2            | Sensory       |      |
| AWCR          | BAGL    | BAGR           | CEPDL         |      |
| CEPDR         | CEPVL   | CEPVR          | FLPL          |      |
| FLPR          | IL1DL   | IL1DR          | IL1R          |      |
| IL1VL         | IL1VR   | 0.1            | IL2DL         |      |
| IL2DR         | IL2L    | IL2R           | IL2VL         |      |
| IL2VR         | NSML    | NSMR           | OLLL          |      |
| OLLR          | OLQDL   | OLQDR          | OLQVL         |      |
| OLQVR         | 0       | URADL          | URADR         |      |
| URAVL         | URAVR   | F0             | URBL          |      |
| URBR          | URXL    | F              | URYDL         |      |
| URXR          | <Δ      | URYVL          | URYDR         |      |
| ADAL          | URYVR   | –0.1           | AIBL          |      |
| ADAR          | AIML    | AIBR           | AINL          |      |
| AIMR          | AIYL    | AIZL           | AIYR          |      |
| RespondingALA | AIZR    | AVAR           | AVAL          | –0.2 |
| AVBR          | AVBL    | AVDR           | AVDL          |      |
| AVER          | AVEL    | AVHL           | AVFL          |      |
| AVJL          | AVHR    | Interneuron    | AVJR          |      |
| AVKL          | AVKR    | AVL            | I1L           | –0.3 |
| I1R           | I2L     | I2R            | I3            |      |
| I4            | I6      | RIAL           | RIAR          |      |
| RIBL          | RIBR    | RICL           | RICR          |      |
| RIFR          | RIGL    | <–0.4          | RIGR          |      |
| RIH           | >0.5    | 0              | RIPL          |      |
| RIR           | q value | RIS            | RIVL          |      |
| RIVR          | SAADL   | SAADR          | SAAVL         |      |
| SAAVR         | SABD    | No measurement | SABVL         |      |
| SABVR         | SIBVR   | AS1            | DA1           |      |
| DB2           | DD1     | M1             | Not displayed |      |
| M2L           | M2R     | M3L            | M3R           |      |
| M5            | MCL     | MCR            | MI            |      |
| RID           | RIML    | Motor          | RIMR          |      |
| RMDDL         | RMDDR   | RMDL           | RMDR          |      |
| RMDVL         | RMDVR   | RMED           | RMEL          |      |
| RMER          | RMEV    | RMFL           | RMFR          |      |
| RMGL          | RMGR    | SMBDL          | SMBDR         |      |
| SMBVL         | SMBVR   | SMDDL          | SMDDR         |      |
| SMDVL         | SMDVR   | VA1            | VB1           |      |
| VB2           | SMDDL   | SMDVL          | VB2           |      |
| SMBDL         | VA1     | RMGL           | RMFL          |      |
| SMBVL         | RMER    | RMED           | RMDVL         |      |
| IL2R          | RMDL    | IL2VR          | NSMR          |      |
| OLQDR         | OLLR    | RMDDL          | SABD          |      |
| DB2           | RIML    | SABVR          | AS1           |      |
| MI            | M2RMCL  | IL1RIL2DR      | M1            |      |
| M3R           | IL1VR   | OLQVR          | URADR         |      |
| URAVR         | URBR    | URXR           | AVJR          |      |
| URYDR         | RIAR    | RIBR           | RIR           |      |
| SAADL         | ADER    | IL1DL          | RIH           |      |
| SAAVL         | FLPL    | CEPDL          | BAGL          |      |
| CEPVL         | AVHR    | AVFL           | URYVR         |      |
| AVDL          | I1LI2L  | AVKR           | RIGL          |      |
| RIVL          | AFDL    | RICR           | AQR           |      |
| ADLL          | ASER    | ASGR           | AWCL          |      |
| ASHR          | ASIR    | AWBL           | AINR          |      |
| ASJR          | AUAR    | AIYR           | AVBL          |      |
| AWAL          | AIMR    | AVEL           | ASKR          |      |
| ADAR          | AVAL    | AIBR           | AIZR          |      |
| I3            | I6      | RMGR           | VB1           |      |
| SMDDR         | SMBVR   | SMBDRSMDVR     | RMFR          |      |
| RMEV          | RMEL    | RMDVR          | RMDDR         |      |
| RMDR          | DA1     | RIMR           | SIBVR         |      |
| M2L           | IL2L    | M3L            | IL2VL         |      |
| NSML          | OLQDL   | OLLL           | OLQVL         |      |
| URADL         | SAADR   | SABVL          | SAAVR         |      |
| RID           | DD1     | MCR            | IL2DL         |      |
| IL1VL         | CEPDL   | URAVL          | URBL          |      |
| URXL          | AVJL    | URYDL          | AVL           |      |
| I4            | URYVL   | AVKL           | RIAL          |      |
|               | RIBL    | RIGR           | RIS           | RIFR |
| RIVR          | ADEL    | RICL           | RIPL          |      |
| ADFL          | AWCR    | FLPR           | BAGR          |      |
| CEPVL         | AVBR    | AVHL           | I1R           |      |
|               | AVDR    | I2R            | AFDR          | ADAL |
| AVER          | ASEL    | ADLR           | ASGL          |      |
| ASHL          | AWBR    | ASIL           | ASJL          |      |
| AWAR          | AUAL    | AVG            | AIML          |      |
| ASKL          | AIBL    | AIZL           | AVAR          |      |
|               | Sensory | Interneuron    | Motor         |      |

b

Stimulated

c 0.50

d

e l 0.12

&#x3C; 0.05 given

&#x3C; 0.05

Inhibitory fraction

Probability of

0.15

0.25

q

of

0

0

q 0

All Bilateral

pair

Max q value

Minimum anatomical

path length (l)

f 0.50

Density of pairs

q &#x3C; 0.05

connections

g

Probability of being functionally non-connected

(qeq &#x3C; 0.05) given l.

To further compare our measurements to count are properties of only the direct (monosynaptic) connection between two neurons, but our signal propagation measurements reflect contributions from all paths through the network.

Nature Vol 623 9 November 2023 409

    Page 5

Article

# Effective connection

| a             | b        | \*\*\*\*         | c                      | d                        |        |
| ------------- | -------- | ---------------- | ---------------------- | ------------------------ | ------ |
|               |          | 102              | 0                      |                          | unc-31 |
|               |          | 100              |                        |                          | WT     |
|               |          | 2                |                        | )                        |        |
|               | 0        | 2                |                        | R                        |        |
| A             | F        |                  |                        | Agreement with anatomy ( | –0.04  |
| F             |          | 1                |                        | V                        |        |
| Δ             | Measured | F0               |                        | versus                   |        |
| 1             | F        | Δ                | 0                      |                          |        |
| Direct path   |          |                  |                        | F0                       | –0.08  |
| Indirect path | 0        | Functionally not | connected (qeq < 0.05) |                          |        |
|               |          | –1               | Functionally connected | (q < 0.05)               |        |

ΔV ≤ 0.1  ΔV > 0.1                        10–8      10–5            10–2  101

Anatomy-derived response                       Anatomy-derived response |ΔV| (V)                 Anatomical                        Fitted

(biophysical model)                                 (biophysical model)                                      weights          weights

# Fig. 3 | Functional measurements differ from anatomy-based predictions.

a, Signals propagate along all paths, including indirect and recursive (coloured). Anatomical descriptions such as synapse count describe only direct paths (black). Connectome-constrained simulations are therefore used to predict signal propagation from anatomy. b, Pairs predicted from anatomy to have large downstream responses (ΔV > 0.1 V, n = 23, 454 pairs) tend to have stronger measured responses (ΔV &#x3C; 0.1 V, n = 614 pairs). **** indicates P = 10−88, one-sided Kolmogorov–Smirnov test; whiskers indicate range. c, Bottom, measured downstream response (ΔF/F) versus anatomy-derived response (ΔV) for pairs that we observe to be functionally connected (q &#x3C; 0.05, blue) and functionally non-connected (qeq &#x3C; 0.05, orange). Vertical grey line is (0.1 V) for comparison with b. Top, marginal distributions (y axis is log scale). Measured functionally connected pairs are enriched for predicted ΔV > 0.1 V, compared to functionally non-connected pairs (P &#x3C; 0.0001, one-sided Kolmogorov–Smirnov test). d, Agreement of measured responses to anatomy-predicted responses is shown for WT (green) and unc-31 (cyan) animals, either using weights and signs from anatomy, or when weights and signs are fitted optimally. Agreement is reported as R² coefficient for the line of best fit: ΔF/F₀ = mΔV. Perfect agreement would be R² = 1.

the two, we relied on a connectome-constrained biophysical model that predicts signal propagation from anatomy, considering all paths. We measured signal propagation in unc-31-mutant animals, which are defective for extrasynaptic signalling mediated by dense-core vesicles, as explained below. Although agreement was still poor, signal propagation in these animals showed better agreement with anatomy than it did in WT animals (Fig. 3d). This prompted us to consider extrasynaptic signalling further.

# Extrasynaptic signalling also drives neural dynamics

Neurons can communicate extrasynaptically by releasing transmitters, often via dense-core vesicles, that diffuse through the extracellular milieu to reach downstream neurons instead of directly traversing a synaptic cleft (Supplementary Information). Extrasynaptic signalling forms an additional layer of communication not visible from anatomy⁴⁹ and its molecular machinery is ubiquitous in mammals⁵⁰ and C. elegans38,51,52.

To examine the role of extrasynaptic signalling, we measured the signal propagation of unc-31-mutant animals defective for dense-core-vesicle-mediated release (Extended Data Fig. 7a; 18 individuals) and compared the results with those from WT animals (browsable online at https://funconn.princeton.edu). This mutation disrupts dense-core-vesicle-mediated extrasynaptic signalling of peptides and monoamines by removing UNC-31 (CAPS), a protein involved in dense-core-vesicle fusion⁵³.

We expected that most signalling in the brain visible within the time scales of our measurements (30 s) would be mediated by chemical or electrical synapses and would therefore be unaffected by the unc-31 mutation. Consistent with this, many individual functional connections that we observed in the WT case persisted in the unc-31 mutant (Extended Data Fig. 8). But if fast dense-core-vesicle-dependent extrasynaptic signalling were present, it should be observed only in WT and not in unc-31-mutant individuals. Consistent with this, unc-31 animals had a smaller proportion of functional connections than did WT animals (Extended Data Fig. 7b).

We investigated the neuron RID, a cell that is thought to signal to other neurons extrasynaptically through neuropeptides, and that has

410 | Nature | Vol 623 | 9 November 2023

    Page 6

# Fig. 4 | Anatomy does not capture extrasynaptic signalling from the neuron

| a             |        |       |                               |       | RID→ADLR          | b      |               |          |                   |          |   |    |
| ------------- | ------ | ----- | ----------------------------- | ----- | ----------------- | ------ | ------------- | -------- | ----------------- | -------- | - | -- |
|               | 10¹    |       |                               |       | RID→AWBR          | F⁰ 0.5 | 0.5           |          |                   |          |   |    |
|               |        |       |                               |       | RID→URXL          | /      |               |          |                   |          |   |    |
|               |        |       |                               |       | All→All           | F      | 0             | 0        |                   |          |   |    |
|               | 10⁰    |       |                               |       | RID→All           | Δ      | RID→URXL (WT) | 1        | RID→URXL (unc-31) |          |   |    |
| Density       |        |       |                               |       |                   |        |               |          |                   |          |   |    |
|               | 10–1   |       |                               |       |                   |        | 2             | 5        |                   |          |   |    |
|               |        |       |                               |       |                   |        | 3             | 9        |                   |          |   |    |
|               |        |       |                               |       |                   |        | 4             |          |                   |          |   |    |
|               | 10–2   |       |                               |       |                   |        | 5             | 13       |                   |          |   |    |
|               |        |       |                               |       |                   |        | 6             |          |                   |          |   |    |
|               | 10–3   | 0     | 0.5                           | 1.0   | 1.5               | 2.0    |               |          |                   |          |   |    |
|               | –10    | 0     | Time (s)                      | 20    | –10               | 0      | Time (s)      | 20       |                   |          |   |    |
| c             |        |       | Anatomy-derived responses (V) | d     |                   |        |               |          |                   |          |   |    |
|               | F⁰ 0.5 | 0.5   |                               |       |                   |        |               |          |                   |          |   |    |
|               |        |       |                               |       |                   | /      |               |          |                   |          |   |    |
|               |        |       |                               |       |                   | F      | 0             | 0        |                   |          |   |    |
|               | Δ      | 1     | RID→ADLR (WT)                 | 1     | RID→ADLR (unc-31) |        |               |          |                   |          |   |    |
| Sorted trials |        |       |                               |       |                   |        |               | 3        | 5                 |          |   |    |
|               | 2      |       | 5                             |       |                   |        | 9             | 13       |                   |          |   |    |
|               | 3      |       | 7                             |       |                   | 13     |               | 19       |                   |          |   |    |
|               |        |       | 9                             |       |                   | 17     |               | 25       |                   |          |   |    |
|               |        |       |                               |       |                   |        | –10           | 0        | 20                | –10      | 0 | 20 |
|               |        |       |                               |       |                   |        | Time (s)      | Time (s) | Time (s)          | Time (s) |   |    |
|               | –1     | 0     | 1                             | –1    | 0                 | 1      |               |          |                   |          |   |    |
|               |        | ΔF/F₀ |                               | ΔF/F₀ |                   |        |               |          |                   |          |   |    |

RID. a, ADL, AWB and URX are predicted from anatomy to have no response to RID stimulation because there is no strong anatomical path from RID to those neurons (vertical lines at or near 0 V). Their anatomy-predicted responses are shown within the distribution of anatomy-predicted responses for all neuron pairs (blue histogram), as in Fig. 3b. b–d, Activity of neurons URXL (b), ADLR (c) and AWBR (d) to RID stimulation, in WT and unc-31 mutant backgrounds. Top, mean (blue) and s.d. (shading) across trials and animals. Bottom, individual traces are sorted across trial and animal by mean response amplitude. Here, trials are shown even in cases when RID activity was not measured. Additional neurons are shown in Extended Data Fig. 7c.

only few and weak outgoing wired connections. RID had dim tagRFP-T expression, so we adjusted our analysis protocol for only this neuron, as described in the Methods. Many neurons responded to RID activation (Extended Data Fig. 7c), including URX, ADL and AWB, three neuron subtypes that were predicted from anatomy to have no response (Fig. 4a). These three neurons showed strong responses in WT animals but their responses were reduced or absent in unc-31 mutants (Fig. 4b–d), consistent with dense-core-vesicle-mediated extrasynaptic signalling. The gene expression and wiring of these neurons also suggest that peptidergic extrasynaptic signalling is producing the observed responses. All three express receptors for peptides produced by RID (NPR-4 and NPR-11 for FLP-14 and PDFR-1 for PDF-1), and no direct (monosynaptic) wiring connects RID to URX, ADL or AWB: a minimum of two hops are required from RID to URXL or AWBR, and three from RID to ADLR. These shortest paths all rely on fragile single-contact synapses that appear in only one out of the four individual connectomes. We conclude that RID signals to other neurons extrasynaptically, and that this is captured by signal propagation measurements but not by anatomy.

signal propagation for those neuron pairs that passed our screen were similar to that of all functional connections (Fig. 5a), suggesting that in the worm, unc-31-dependent extrasynaptic signalling can also propagate quickly.

Neuron pair M3L→URYVL is a representative example of a purely extrasynaptic-dependent connection found from our screen. There are no direct chemical or electrical synapses between M3L and URYVL, but stimulation of M3L evokes unc-31-dependent calcium activity in URYVL (Fig. 5b). The majority of neuron pairs identified in our screen express peptide and receptor combinations consistent with extrasynaptic signalling (Supplementary Table 1). For example, M3L expresses FLP-4, which binds to the receptor NPR-4, expressed by URVYL; and FLP-5, which binds to the receptor NPR-11, also expressed by URYVL. The bilateral neuron pair AVDR and AVDL was also identified in our screen for having purely extrasynaptic-dependent connections.

AVDR and AVDL have no or only weak wired connections between them (three of four connectomes show no wired connections, and the fourth finds only a very weak gap junction), but stimulation of AVDR evoked robust unc-31-dependent responses in AVDL. Notably, the AVD cell type was recently predicted to have a peptidergic autocrine loop mediated by the neuropeptide–GPCR combinations NLP-10→NPR-35 and FLP-6→FRPR-8 (refs. 38,52) (Fig. 5c). The bilateral extrasynaptic signalling that we observe is consistent with this prediction because two neurons that express the same autocrine signalling machinery can necessarily signal to one another. AVD was also predicted to be among the top 25 highest-degree ‘hub’ nodes in a peptidergic network based on gene expression, and, in agreement, AVD is highly represented among hits in our screen.

Signal propagation predicts spontaneous activity. A key motivation for mapping neural connections is to understand how they give rise to collective neural dynamics. We tested the ability.

    Page 7

Article

# Candidate purely extrasynaptic-dependent functional connections

# a

Distribution of signal propagation timescales.

|                       | 10²                          | All |    |   |
| --------------------- | ---------------------------- | --- | -- | - |
| Number of connections | 10¹                          |     |    |   |
|                       | 10⁰                          |     |    |   |
| 0                     | 5                            | 10  | 15 |   |
|                       | Average kernel rise time (s) |     |    |   |

# b

WT unc-31

| M3L (stimulated) | URYVL (responding) | 1   | M3L (stimulated) | 1  | URYVL (responding) |    |
| ---------------- | ------------------ | --- | ---------------- | -- | ------------------ | -- |
| 0                | 1                  | 1   | F⁰               | F  | /                  |    |
| 0                | 0                  | F   | F                | Δ  | Δ                  |    |
| 0                | 0                  | –10 | 0                | 10 | 20                 | 30 |
| –10              | 0                  | 10  | 20               | 30 |                    |    |

# c

AVDR (stimulated) AVDL (responding)

| 0   | 0.5 | 0.5 | 0   | 1.0 | 1.0 |
| --- | --- | --- | --- | --- | --- |
| F   | F   | 0.5 | 0.5 |     |     |
| F   | F   | Δ   | 0   | 0   | Δ   |
| –10 | 0   | 10  | 20  | 30  |     |

Neuropeptide–receptor combinations

| AVDR | AVDL | NLP-10–NPR-35 | FLP-6–FRPR-8 |    |
| ---- | ---- | ------------- | ------------ | -- |
| –10  | 0    | 10            | 20           | 30 |

Fig. 5 | Candidate purely extrasynaptic-dependent functional connections. Communication is putatively mediated in autocrine loops through NLP-10→

b,c, Paired responses for NPR-35 and FLP-6→FRPR-8 signalling. Top, average (blue) and s.d. (shading) M3L→URYVL (b) and AVDR→AVDL (c), for WT and unc-31 animals. unc-31 animals do not show downstream responses to stimulation. AVDR→AVDL extrasynaptic.

of our signal propagation map to predict worms’ spontaneous activity, and compared this to predictions from anatomy (Fig. 6). Spontaneous activity was measured in immobilized worms lacking optogenetic actuators under bright imaging conditions. A matrix of bare anatomical weights (synapse counts) was a poor predictor of the correlations of spontaneous activity (left bar, Fig. 6), consistent with previous reports27,41. The connectome-constrained biophysical model from Fig. 3 better predicted spontaneous activity correlations (middle bars, Fig. 6; described in the Methods)—as we would expect because it considers all anatomical paths through the network—but it still performed fairly poorly. Predictions based on our functional measurements of signal propagation kernels (right bars, Fig. 6) performed best of all at predicting spontaneous activity correlations. To generate predictions of correlations either from the biophysical model or from our functional kernel measurements required the activity of a set of neurons to be driven in silico. For the biophysical model, driving all neurons was optimal, but for the kernel-based predictions, driving a specific set of six neurons (‘top-n’) markedly improved performance. We conclude that functionally derived predictions based on our measured signal propagation kernels better agree with spontaneous activity than do either a bare description of anatomical weights or an established model constrained by the connectome, and that some subsets of neurons make outsized contributions to driving spontaneous dynamics. The kernel-based simulation (interactive version at https://funsim.princeton.edu) outperforms other models of neural dynamics presumably for two reasons: first, it extracts all relevant parameters directly from.

412 | Nature | Vol 623 | 9 November 2023

    Page 8

# Nature | Vol 623 | 9 November 2023 | 413

All driven questions that motivate our work, such as how a stimulus in one part of the network drives activity in another. Direct connections are suited for questions of gene expression, development and anatomy, but less so for network function. For example, a direct connection between two neurons could be slow or weak, but might overlook a fast and strong effective connection via other paths through the network.

We used a connectome-constrained biophysical model to provide additional evidence to support our claim that measured signal propagation differs from expectations based on anatomy. The model relies on assumptions of timescales, nonlinearities and other parameters that, if incorrect, would contribute to the observed disagreement between anatomy and function. But even without any biophysical model, discrepancies between anatomy and function are apparent; for example, in pairs of neurons with synaptic connections that are functionally non-connected (Fig. 2g), and in strong functional connections between RID and other neurons that have only weak, variable and indirect synaptic connections (Fig. 4).

Fig. 6 | Measured signal propagation better predicts spontaneous activity than anatomy does. Agreement (as Pearson’s correlation (corr.) coefficient) between the correlation matrix of spontaneous activity recorded from an immobilized animal and various predictions of those correlations, including: the bare anatomical weight matrix (synapse counts) (left); correlations predicted by the anatomy-derived biophysical model (middle); and correlations functionally derived from the measured signal propagation kernels (right). Anatomy-derived and functionally derived correlations are calculated by driving activity in silico in all neurons (dark blue) or only an optimal subset of top-n neurons (light blue). NA, not applicable.

The signal propagation atlas presented here informs structure–function investigations at both the circuit and the network level, and enables more accurate brain-wide simulations of neural dynamics. The finding that extrasynaptic peptidergic signalling, which is invisible to the measured kernels, thereby avoiding the need for many assumptions; and second, it captures extrasynaptic signalling not visible from anatomy.

# Discussion

Signal propagation in C. elegans measured by neural activation differs from model predictions based on anatomy, in part because anatomy does not account for wireless connections such as the extrasynaptic release of neuropeptides⁴⁹. By directly evoking calcium activity on a timescale of seconds, extrasynaptic signalling serves a functional role similar to that of classical neurotransmitters and contributes to neural dynamics. This role is in addition to its better-characterized role in modulating neural excitability over longer timescales.

Peptidergic extrasynaptic signalling relies on diffusion and therefore may be uniquely well suited to C. elegans’ small size. Mammals also express neuropeptides and receptors, including in the cortex⁵⁰, but their larger brains might limit the speed, strength or spatial extent of peptidergic extrasynaptic signalling. Plasticity, neuromodulation, neural-network state, experience dependence and other longer-timescale effects might contribute to variability in our measured responses or to discrepancies between anatomical and functional descriptions of the C. elegans network. A future direction will be to search for latent connections that might become functional only during certain internal states.

Our signal propagation map provides a lower bound on the number of functional connections (Supplementary Information). Our measurements required a trade-off between the animal’s health and its transgenic load. To express the necessary transgenes, we generated a strain that is not behaviourally wild type; its signal propagation might therefore also differ from the wild type. To probe nonlinearities and multi-neuron interactions in the network, future measurements are needed of the network’s response to simultaneous stimulation of multiple neurons.

Our signal propagation map reports effective connections, not direct connections. Effective connections are useful for the circuit-level understanding of neural dynamics.

# Online content

Any methods, additional references, Nature Portfolio reporting summaries, source data, extended data, supplementary information, acknowledgements, peer review information; details of author contributions and competing interests; and statements of data and code availability are available at https://doi.org/10.1038/s41586-023-06683-4.

1. White, J. G., Southgate, E., Thomson, J. N. &#x26; Brenner, S. The structure of the nervous system of the nematode Caenorhabditis elegans. Phil. Trans. R. Soc. B314, 1–340 (1986).
2. Mesulam, M. Imaging connectivity in the human cerebral cortex: the next frontier? Ann. Neurol.57, 5–7 (2005).
3. Abbott, L. F. et al. The mind of a mouse. Cell182, 1372–1376 (2020).
4. Verasztó, C. et al. Whole-animal connectome and cell-type complement of the three-segmented Platynereis dumerilii larva. Preprint at bioRxiv https://doi.org/10.1101/2020.08.21.260984 (2020).
5. Cook, S. J. et al. Whole-animal connectomes of both Caenorhabditis elegans sexes. Nature 571, 63–71 (2019).
6. Witvliet, D. et al. Connectomes across development reveal principles of brain maturation. Nature 596, 257–261 (2021).
7. Chalfie, M. et al. The neural circuit for touch sensitivity in Caenorhabditis elegans. J. Neurosci.5, 956–964 (1985).
8. Gray, J. M., Hill, J. J. &#x26; Bargmann, C. I. A circuit for navigation in Caenorhabditis elegans. Proc. Natl Acad. Sci. USA102, 3184–3191 (2005).
9. Kunert-Graf, J. M., Shlizerman, E., Walker, A. &#x26; Kutz, J. N. Multistability and long-timescale transients encoded by network structure in a model of C. elegans connectome dynamics. Front. Comput. Neurosci.11, 53 (2017).
10. Yan, G. et al. Network control principles predict neuron function in the Caenorhabditis elegans connectome. Nature550, 519–523 (2017).
11. Vaaga, C. E., Borisovska, M. &#x26; Westbrook, G. L. Dual-transmitter neurons: functional implications of co-release and co-transmission. Curr. Opin. Neurobiol.29, 25–32 (2014).
12. O’Malley, D. M., Sandell, J. H. &#x26; Masland, R. H. Co-release of acetylcholine and GABA by the starburst amacrine cells. J. Neurosci.12, 1394–1408 (1992).
13. Johnson, M. D. Synaptic glutamate release by postnatal rat serotonergic neurons in microculture. Neuron 12, 433–442 (1994).
14. Yoo, J. H. et al. Ventral tegmental area glutamate neurons co-release GABA and promote positive reinforcement. Nat. Commun.7, 13697 (2016).
15. Fisher, Y. E., Lu, J., D’Alessandro, I. &#x26; Wilson, R. I. Sensorimotor experience remaps visual input to a heading-direction network. Nature576, 121–125 (2019).
16. Harris-Warrick, R. M. &#x26; Marder, E. Modulation of neural networks for behavior. Annu. Rev. Neurosci.14, 39–57 (1991).

    Page 9

Article

1. Petreanu, L., Huber, D., Sobczyk, A. &#x26; Svoboda, K. Channelrhodopsin-2-assisted circuit mapping of long-range callosal projections. Nat. Neurosci. 10, 663–668 (2007).
2. Guo, Z. V., Hart, A. C. &#x26; Ramanathan, S. Optical interrogation of neural circuits in Caenorhabditis elegans. Nat. Methods 6, 891–896 (2009).
3. Rickgauer, J. P., Deisseroth, K. &#x26; Tank, D. W. Simultaneous cellular-resolution optical perturbation and imaging of place cell firing fields. Nat. Neurosci. 17, 1816–1824 (2014).
4. Packer, A. M., Russell, L. E., Dalgleish, H. W. P. &#x26; Häusser, M. Simultaneous all-optical manipulation and recording of neural circuit activity with cellular resolution in vivo. Nat. Methods 12, 140–146 (2015).
5. Emiliani, V., Cohen, A. E., Deisseroth, K. &#x26; Haeusser, M. All-optical interrogation of neural circuits. J. Neurosci. 35, 13917–13926 (2015).
6. Franconville, R., Beron, C. &#x26; Jayaraman, V. Building a functional connectome of the Drosophila central complex. eLife 7, e37017 (2018).
7. Sharma, A. K., Randi, F., Kumar, S., Dvali, S. &#x26; Leifer, A. M. TWISP: a transgenic worm for interrogating signal propagation in C. elegans. Preprint at bioRxiv https://doi.org/10.1101/2023.08.03.551820 (2023).
8. Bhatla, N. &#x26; Horvitz, H. R. Light and hydrogen peroxide inhibit C. elegans feeding through gustatory receptor orthologs and pharyngeal neurons. Neuron 85, 804–818 (2015).
9. Quintin, S., Aspert, T., Ye, T. &#x26; Charvin, G. Distinct mechanisms underlie HO sensing in C. elegans head and tail. PLoS ONE 17, e0274226 (2022).
10. Chen, T.-W. et al. Ultrasensitive fluorescent proteins for imaging neuronal activity. Nature 499, 295–300 (2013).
11. Yemini, E. et al. NeuroPAL: a multicolor atlas for whole-brain neuronal identification in C. elegans. Cell 184, 272–288 (2021).
12. Lin, A. et al. Functional imaging and quantification of multineuronal olfactory responses in C. elegans. Sci. Adv. 9, eade1249 (2023).
13. Hardaker, L. A., Singer, E., Kerr, R., Zhou, G. &#x26; Schafer, W. R. Serotonin modulates locomotory behavior and coordinates egg-laying and movement in Caenorhabditis elegans. 49, 303–313 (2001).
14. Wicks, S. R., Roehrig, C. J. &#x26; Rankin, C. H. A dynamic network simulation of the nematode tap withdrawal circuit: predictions concerning synaptic function using behavioral criteria. J. Neurosci. 16, 4017–4031 (1996).
15. Kawano, T. et al. An imbalancing act: gap junctions reduce the backward motor circuit activity to bias C. elegans for forward locomotion. Neuron 72, 572–586 (2011).
16. Arous, J. B., Tanizawa, Y., Rabinowitch, I., Chatenay, D. &#x26; Schafer, W. R. Automated imaging of neuronal activity in freely behaving Caenorhabditis elegans. J. Neurosci. Methods 187, 229–234 (2010).
17. Faumont, S. et al. An image-free opto-mechanical system for creating virtual environments and imaging neuronal activity in freely moving Caenorhabditis elegans. PLoS ONE 6, e24666 (2011).
18. Shipley, F. B., Clark, C. M., Alkema, M. J. &#x26; Leifer, A. M. Simultaneous optogenetic manipulation and calcium imaging in freely moving C. elegans. Front. Neural Circuits 8, 28 (2014).
19. Kato, S. et al. Global brain dynamics embed the motor command sequence of Caenorhabditis elegans. Cell 163, 656–669 (2015).
20. Wang, Y. et al. Flexible motor sequence generation during stereotyped escape responses. eLife 9, e56942 (2020).
21. Fenyves, B. G., Szilágyi, G. S., Vassy, Z., Söti, C. &#x26; Csermely, P. Synaptic polarity and sign-balance prediction using gene expression data in the Caenorhabditis elegans chemical synapse neuronal connectome network. PLoS Comput. Biol. 16, e1007974 (2020).
22. Taylor, S. R. et al. Molecular topography of an entire nervous system. Cell 184, 4329–4347 (2021).

© The Author(s) 2023

    Page 10

# Methods

# Worm maintenance

C. elegans were stored in the dark, and only minimal light was used when transferring worms or mounting worms for experiments. Strains generated in this study (Extended Data Fig. 1a) have been deposited in the Caenorhabditis Genetics Center (CGC), University of Minnesota, for public distribution. Hermaphrodites were used in this study.

# Transgenics

We generated a transgenic worm for interrogating signal propagation, TWISP (AML462), which has been described in more detail previously²³. This strain expresses the calcium indicator GCaMP6s in the nucleus of each neuron; a purple-light-sensitive optogenetic protein system (GUR-3 and PRDX-2) in each neuron; and multiple fluorophores of various colours from the NeuroPAL²⁷ system, also in the nucleus of neurons. We also used a QF-hGR drug-inducible gene-expression strategy to turn on the gene expression of optogenetic actuators only later in development. To create this strain, we first generated an intermediate strain, AML456, by injecting a plasmid mix (75 ng μl−1 pAS3-5xQUAS::Δ pes-10P::AI::gur-3G::unc-54 + 75 ng μl−1 pAS3-5xQUAS::Δ pes-10P::AI::prdx-2G::unc-54 + 35 ng μl−1 pAS-3-rab-3P::AI::QF+GR::unc-54 + 100 ng μl−1 unc-122::GFP) into CZ20310 worms, followed by UV integration and six outcrosses 56,57. The intermediate strain, AML456, was then crossed into the pan-neuronal GCaMP6s calcium-imaging strain, with NeuroPAL, AML320 (refs. 23,27,58). Animals exhibited decreased average locomotion compared to the WT (mean speeds of 0.03 mm s−1 off drug and 0.02 mm s−1 on drug compared to the mean of 0.15 mm s−1 in WT animals²³), as expected for NeuroPAL GCaMP6s strains, which are also reported to be overall less active (around 0.09 mm s−1 during only forward locomotion) 27. An unc-31-mutant background with defects in the dense-core-vesicle-release pathway was used to diminish wireless signalling⁵³. We created an unc-31-knockout version of our functional connectivity strain by performing CRISPR–Cas9-mediated genome editing on AML462 using a single-strand oligodeoxynucleotide (ssODN)-based homology-dependent repair strategy 59. This approach resulted in strain AML508 (unc-31 (wtf502) IV; otIs669 (NeuroPAL) V 14x; wtfIs145 (30 ng μl−1 pBX + 30 ng μl−1 rab-3::his-24::GCaMP6s::unc-54); wtfIs348 (75 ng μl−1 pAS3-5xQUAS::Δ pes-10P::AI::gur-3G::unc-54 + 75 ng μl−1 pAS3-5xQUAS::Δ pes-10P::AI::prdx-2G::unc-54 + 35 ng μl−1 pAS-3-rab-3P::QF+GR::unc-54 + 100 ng μl−1 unc-122::GFP)).

CRISPR–Cas-9 editing was carried out as follows. Protospacer adjacent motif (PAM) sites (denoted in upper case) were selected in the first intron (gagcuucgcaauguugacucCGG) and the last intron (augguacauuggguccguggCGG) of the unc-31 gene (ZK897.1a.1) to delete 12,476 out of 13,169 bp (including the 5′ and 3′ untranslated regions) and 18 out of 20 exons from the genomic locus, while adding 6 bp (GGTACC) for the Kpn-I restriction site (Extended Data Fig. 1b). Alt-R S.p. Cas9 Nuclease V3, Alt-R-single guide RNA (sgRNA) and Alt-R homology-directed repair (HDR)-ODN were used (IDT). We introduced the Kpn-I restriction site, denoted in upper case (gacccagcgaagcaaggatattgaaaacataagtacccttgttgttgtgtGGTACCccacggacccaatgtaccatattttacgagaaatttataatgttcagg) into our repair oligonucleotide to screen and confirm the deletion by PCR followed by restriction digestion. sgRNA and HDR ssODNs were also synthesized for the dpy-10 gene as a reporter, as described previously⁵⁹. An injection mix was prepared by sequentially adding Alt-R S.p. Cas9 Nuclease V3 (1 μl of 10 μg μl−1), 0.25 μl of 1 M KCL, 0.375 μl of 200 mM HEPES (pH 7.4), sgRNAs for unc-31 (1 μl each for both sites) and 0.75 μl for dpy-10 from a stock of 100 μM, ssODNs (1 μl for unc-31 and 0.5 μl for dpy-10 from a stock of 25 μM) and nuclease-free water to a final volume of 10 μl in a PCR tube, kept on ice. The injection mix was then incubated at 37 °C for 15 min before it was injected into the germline of AML462 worms. Progenies from plates showing roller or dumpy phenotypes in the F₁ generation after injection were individually propagated and screened by PCR and Kpn-I digestion to confirm deletion. Single-worm PCR was carried out using GXL-PRIME STAR taq-Polymerase (Takara Bio) and the Kpn-1-HF restriction enzyme (NEB). Worms without a roller or dumpy phenotype and homozygous for deletion were confirmed by Sanger sequencing fragment analysis.

To cross-validate GUR-3/PRDX-2-evoked behaviour responses, we generated the transgenic strain AML546 by injecting a plasmid mix (40 ng μl−1 pAS3-rig-3P::AI::gur-3G::SL2::tagRFP::unc-54 + 40 ng μl−1 pAS3-rig-3P::AI::prdx-2G::SL2::tagBFP::unc-54) into N2 worms to generate a transient transgenic line expressing GUR-3/PRDX-2 in AVA neurons.

# Cross-validation of GUR-3/PRDX-2-evoked behaviour

Optogenetic activation of AVA neurons using traditional channelrhodopsins (for example, Chrimson) leads to reversals45,60. We used worms expressing GUR-3/PRDX-2 in AVA neurons (AML564) to show that GUR-3/PRDX-2 elicits a similar behavioural response. We illuminated freely moving worms with blue light from an LED (peaked at 480 nm, 2.3 mW mm−2) for 45 s. We compared the number of onsets of reversals in that period of time with a control in which only dim white light was present, as well as with the results of the same assay performed on N2 worms. Animals with GUR-3/PRDX-2 in AVA (n = 11 animals) exhibited more blue-light-evoked reversals per minute than did WT animals (n = 8 animals) (Extended Data Fig. 2h).

# Dexamethasone treatment

To increase the expression of optogenetic proteins while avoiding arrested development, longer generation time and lethality, a drug-inducible gene-expression strategy was used. Dexamethasone (dex) activates QF-hGR to temporally control the expression of downstream targets⁶¹, in this case the optogenetic proteins in the functional connectivity imaging strains AML462 and AML508. Dex-NGM plates were prepared by adding 200 μM of dex in dimethyl sulfoxide (DMSO) just before pouring the plate. For dex treatment, L2/L3 worms were transferred to overnight-seeded dex-NGM plates and further grown until worms were ready for imaging. More details of the dex treatment are provided below.

We prepared stock solution of 100 mM dex by dissolving 1 g dexamethasone (D1756, Sigma-Aldrich) in 25.5 ml DMSO (D8418, Sigma-Aldrich). Stocks were then filter-sterilized, aliquoted, wrapped in foil to prevent light and stored at −80 °C until needed. The 200-μM dex-NGM plates were made by adding 2 ml of 100 mM dex stock in 1 l NGM-agar medium, while stirring, 5 min before pouring the plate. Dex plates were stored at 4 °C for up to a month until needed.

# Preparation of worms for imaging

Worms were individually mounted on 10% agarose pads prepared with M9 buffer and immobilized using 2 μl of 100-nm polystyrene beads solution and 2 μl of levamisole (500 μM stock). This concentration of levamisole, after dilution in the polystyrene bead solution and the agarose pad water, largely immobilized the worm while still allowing it to slightly move, especially before placing the coverslip. Pharyngeal pumping was observed during imaging.

# Overview of the imaging strategy

We combined whole-brain calcium imaging through spinning disk single-photon confocal microscopy with two-photon targeted optogenetic stimulation⁶⁵, each with their own remote focusing system, to measure and manipulate neural activity in an immobilized animal (Fig. 1a). We performed calcium imaging, with excitation light at a wavelength and intensity that does not elicit photoactivation of GUR-3/PRDX-2 (ref. 66) (Extended Data Fig. 2b). We also used genetically encoded fluorophores from NeuroPAL expressed in each neuron²⁷ to identify neurons consistently across animals (Fig. 1c).

    Page 11

# Article

# Multi-channel imaging and neural identification

Volumetric, multi-channel imaging was performed to capture images of the following fluorophores in the NeuroPAL transgene: mtagBFP2, CyOFP1.5, tagRFP-T and mNeptune2.5 (ref. 27). Light downstream of the same spinning disk unit used for calcium imaging travelled on an alternative light path through channel-specific filters mounted on a mechanical filter wheel, while mechanical shutters alternated illumination with the respective lasers, similar to a previously described method⁵⁸. Channels were as follows: mtagBFP2 was imaged using a 405-nm laser and a Semrock FF01-440/40 emission filter; CyOFP1.5 was imaged using a 505-nm laser and a Semrock 609/54 emission filter; tagRFP-T was imaged using a 561-nm laser and a Semrock 609/54-nm emission filter; and mNeptune2.5 was imaged using a 561-nm laser and a Semrock 732/68-nm emission filter.

For functional connectivity experiments, an intensity of 1.4 mW mm−2 at the sample plane was used to image GCaMP6s, well below the threshold needed to excite the GUR-3/PRDX-2 optogenetic system 24. We note that at this wavelength and intensity, animals exhibited very little spontaneous calcium activity.

For certain analyses (Fig. 6), recordings with ample spontaneous activity were desired. In those cases, we increased the 505-nm intensity sevenfold, to approximately 10 mW mm−2, and recorded from AML320 strains that lacked exogenous GUR-3/PRDX-2 to avoid potential wide-spread neural activation. Under these imaging conditions, we observed population-wide slow stereotyped spontaneous oscillatory calcium dynamics, as previously reported35,68.

# Extraction of calcium activity from the images

Calcium activity was extracted from the raw images by using Python libraries implementing optimized versions of a previously described algorithm⁶⁹, available at https://www.github.com/leiferlab/pump-probe, https://www.github.com/leiferlab/wormdatamodel, https://www.github.com/leiferlab/wormneuronsegmentation-c and https://www.github.com/leiferlab/wormbrain.

The positions of neurons in each acquired volume were determined by computer vision software implemented in C++. This software was greatly optimized to identify neurons in real time, to also enable closed-loop targeting and stimulus delivery (as described in ‘Stimulus delivery and pulsed laser’). Two design choices made this algorithm considerably faster than previous approaches. First, a local maxima search was used instead of a slower watershed-type segmentation. Neurons in the ventral ganglion are hard to identify because it appears as very crowded when viewed in the most common orientation that worms assume when mounted on a microscope slide. The nuclei of C. elegans neurons are approximately spheres and so they can be identified and separated by a simple local maxima search. Second, we factorized the three-dimensional (3D) local maxima search into multiple two-dimensional (2D) local maxima searches. In fact, any local maximum in a 3D image is also a local maximum in the 2D image in which it is located. Local maxima were therefore first found in each 2D image separately, and then candidate local maxima were discarded or retained by comparing them to their immediate surroundings in the other planes. This makes the algorithm less computationally intensive and fast enough to also be used in real time. We refer to this type of algorithm as ‘pseudo’-segmentation because it finds the centre of neurons without fully describing the extent and boundaries of each neuron.

# Volumetric image acquisition

Neural activity was recorded at whole-brain scale and cellular resolution through continuous acquisition of volumetric images in the red and green channels with a spinning disk confocal unit and using LabView software (https://github.com/leiferlab/pump-probe-acquisition/tree/pp), similarly to a previous study⁶⁷, with a few upgrades. The imaging focal plane was scanned through the brain of the worm remotely using an electrically tunable lens (Optotune EL-16-40-TC) instead of moving the objective. The use of remote focusing allowed us to decouple the z-position of the imaging focal plane and that of the optogenetics two-photon spot (described below). Images were acquired by an sCMOS camera, and each acquired image frame was associated to the focal length of the tunable lens (z-position in the sample) at which it was acquired. To ensure the correct association between frames and z-position, we recorded the analogue signal describing the focal length of the tunable lens at time points synchronous with a trigger pulse output by the camera. By counting the camera triggers from the start of the recording, the z-positions could be associated to the correct frame, bypassing unknown operating-system-mediated latencies between the image stream from the camera and the acquisition of analogue signals.

# Calcium pre-processing

The GCaMP6s intensity extracted from the images undergoes the following pre-processing steps. (1) Missing values are interpolated on the basis of neighbouring time points. Missing values can occur when a neuron cannot be identified in a given volumetric image. (2) Photo-bleaching is removed by fitting a double exponential to the baseline signal. (3) Outliers more than 5 standard deviations away from the average are removed from each trace. (4) Traces are smoothed using a causal polynomial filtering with a window size of 6.5 s and polynomial order of 1 (Savitzky–Golay filters with windows completely ‘in the past’; for example, obtained with scipy.signal.savgol_coeffs(window_length=13, polyorder=1, pos=12)). This type of filter with the chosen parameters is able to remove noise without smearing the traces in time. Note that when fits are performed (for example, to calculate kernels), they are always performed on the original, non-smoothed traces.

# Calcium imaging

Calcium imaging was performed in a single-photon regime with a 505-nm excitation laser through spinning disk confocal.

    Page 12

(5) Where ΔF/F₀ of responses is used, F₀ is defined as the value of F in a 30-s interval before the stimulation time and ΔF ≡ F − F₀. In Fig. 2a, for example, &#x3C;ΔF/F₀> refers to the mean over a 30-s post-stimulus window.

# Stimulus delivery and pulsed laser

For two-photon optogenetic targeting, we used an optical parametric amplifier (OPA; Light Conversion ORPHEUS) pumped by a femtosecond amplified laser (Light Conversion PHAROS). The output of the OPA was tuned to a wavelength of 850 nm, at a 500 kHz repetition rate. We used temporal focusing to spatially restrict the size of the two-photon excitation spot along the microscope axis. A motorized iris was used to set its lateral size. For temporal focusing, the first-order diffraction from a reflective grating, oriented orthogonally to the microscope axis, was collected (as described previously⁷¹) and travelled through the motorized iris, placed on a plane conjugate to the grating. To arbitrarily position the two-photon excitation spot in the sample volume, the beam then travelled through an electrically tunable lens (Opto-tune EL-16-40-TC, on a plane conjugate to the objective), to set its position along the microscope axis, and finally was reflected by two galvo-mirrors to set its lateral position. The pulsed beam was then combined with the imaging light path by a dichroic mirror immediately before entering the back of the objective.

Most of the stimuli were delivered automatically by computer control. Real-time computer vision software found the position of the neurons for each volumetric image acquired, using only the tagRFP-T channel. To find neural positions, we used the same pseudo-segmentation algorithm described above. The algorithm found neurons in each 2D frame in around 500 μs as the frames arrived from the camera. In this way, locations for all neurons in a volume were found within a few milliseconds of acquiring the last frame of that volume.

Every 30 s, a random neuron was selected among the neurons found in the current volumetric image, on the basis of only its tagRFP-T signal. After galvo-mirrors and the tunable lens set the position of the two-photon spot on that neuron, a 500-ms (300-ms for the unc-31-mutant strain) train of light pulses was used to optogenetically stimulate that neuron. The duration of stimulus illumination for the unc-31-mutant strain was selected to elicit calcium transients in stimulated neurons with a distribution of amplitudes such that the maximum amplitude was similar to those in WT-background animals, (Extended Data Fig. 2f). The output of the laser was controlled through the external interface to its built-in pulse picker, and the power of the laser at the sample was 1.2 mW at 500 kHz. Neuron identities were assigned to stimulated neurons after the completion of experiments using NeuroPAL²⁷.

To probe the AFD→AIY neural connection, a small set of stimuli used variable pulse durations from 100 ms to 500 ms in steps of 50 ms selected randomly to vary the amount of optogenetic activation of AFD. In some cases, neurons of interest were too dim to be detected by the real-time software. For those neurons of interest, additional recordings were performed in which the neuron to be stimulated was manually selected on the basis of its colour, size and position. This was the case for certain stimulations of neurons RID and AFD.

# Characterization of the size of the two-photon excitation spot

The lateral (xy) size of the two-photon excitation spot was measured with a fluorescent microscope slide, and the axial (z) size was measured using 0.2-nm fluorescent beads (Suncoast Yellow, Bangs Laboratories), by scanning the z-position of the optogenetic spot while maintaining the imaging focal plane fixed (Extended Data Fig. 2a).

We further tested our targeted stimulation in two ways: selective photobleaching and neuronal activation. First, we targeted individual neurons at various depths in the worm’s brain, and we illuminated them with the pulsed laser to induce selective photobleaching of tagRFP-T. Extended Data Fig. 2c,d shows how our two-photon excitation spot selectively targets individual neurons, because it photobleaches tagRFP-T only in the neuron that we decide to target, and not in nearby neurons. To faithfully characterize the spot size, we set the laser power such that the two-photon interaction probability profile of the excitation spot would not saturate the two-photon absorption probability of tagRFP-T. Second, we showed that our excitation spot is restricted along the z-axis by targeting a neuron and observing its calcium activity. When the excitation was directed at the neuron but shifted by 4 μm along z, the neuron showed no activation. By contrast, the neuron showed activation when the spot was correctly positioned on the neuron (Extended Data Fig. 2e). To further show that our stimulation is spatially restricted to an individual neuron more broadly throughout our measurements, we show that stimulations do not elicit responses in most of the close neighbours of the targeted neurons (Extended Data Fig. 2i and Supplementary Information).

# Inclusion criteria

Stimulation events were included for further analysis if they evoked a detectable calcium response in the stimulated neuron (autoresponse). A classifier determined whether the response was detected by inspecting whether the amplitude of both the ΔF/F₀ transient and its second derivative exceeded a pair of thresholds. The same threshold values were applied to every animal, strain, neuron and stimulation event, and were originally set to match the human perception of a response above noise. Stimulation events that did not meet both thresholds for a contiguous 4 s were excluded. The RID responses shown in Fig. 4 and Extended Data Fig. 7c are an exception to this policy. RID is visible on the basis of its CyOFP expression, but its tagRFP-T expression is too dim to consistently extract calcium signals. Therefore, in Fig. 4 and Extended Data Fig. 7c (but not in other figures, such as Fig. 2), downstream neurons’ responses to RID stimulation were included even in cases in which it was not possible to extract a calcium-activity trace in RID.

Neuron traces were excluded from analysis if a human was unable to assign an identity or if the imaging time points were absent in a contiguous segment longer than 5% of the response window owing to imaging artefacts or tracking errors. A different policy applies to dim neurons of interest that are not automatically detected by the pseudo-segmentation algorithm in the 3D image used as reference for the point-set registration algorithm. In those cases, we manually added the position of those neurons to the reference 3D image. If these ‘added’ neurons are automatically detected in most of the other 3D images, then a calcium activity trace can be successfully produced by the DSMM nonrigid registration algorithm, and is treated as any other trace. However, if the ‘added’ neurons are too dim to be detected also in the other 3D images and the calcium activity trace cannot be formed for more than 50% of the total time points, the activity trace for those neurons is extracted from the neuron’s position as determined from the position of neighbouring neurons. In the analysis code, we refer to these as ‘matchless’ traces, because the reference neuron is not matched to any detected neuron in the specific 3D image, but its position is just transformed according to the DSMM nonrigid deformation field. In this way, we are able to recover the calcium activity of some neurons whose tagRFP-T expression is otherwise too dim to be reliably detected by the pseudo-segmentation algorithm. Responses to RID stimulation shown in Fig. 4 and Extended Data Fig. 7c are an exception to this policy. In these cases, the activity of any neuron for which there is not a trace for more than 50% of the time points is substituted with the corresponding ‘matchless’ trace, and not just for the manually added neurons. This is important to be able to show responses of neurons such as ADL, which have dim tagRFP-T expression. In the RID-specific case, to exclude responses that become very large solely because of numerical issues in the division by the baseline activity owing to the dim tagRFP-T, we also introduce a threshold excluding ΔF/F > 2.

    Page 13

Kernels were computed only for stimulation-response events for which the automatic classifier detected responses in both the stimulated and the downstream neurons. If the downstream neuron did not show a response, we considered the downstream response to be below the noise level and the kernel to be zero.

# Fitting kernels

Kernels *kij(t) were defined as the functions to be convolved with the activity ΔFj of the stimulated neuron to obtain the activity ΔFi of a responding neuron i, such that ΔFi(t) = (k * ΔFj)(t)*.

We used two statistical tests to identify neuron pairs that under our stimulation and imaging conditions can be deemed ‘functionally connected’, ‘functionally non-connected’ or for which we lack the confidence to make either determination. Both tests compare observed calcium transients in each downstream neuron to a null distribution of transients recorded in experiments lacking stimulation.

To determine whether a pair of neurons can be deemed functionally connected, we calculated the probability of observing the measured calcium response in the downstream neuron given no neural stimulation. We used a two-sided Kolmogorov–Smirnov test to compare the distributions of the downstream neuron’s *ΔF/F0 amplitude and its temporal second derivative from all observations of that neuron pair under stimulation to the empirical null distributions taken from control recordings lacking stimulation. P values were calculated separately for ΔF/F0* and its temporal second derivative, and then combined using Fischer’s method to report a single fused P value for each neuron pair. Finally, to account for the large number of hypotheses tested, a false discovery rate was estimated.

From the list of P values, each neuron was assigned a *q value using the Storey–Tibshirani method40. q values are interpreted as follows: when considering an ensemble of putative functional connections of q values all less than or equal to q, an approximately q* fraction of those connections would have appeared in a recording that lacked any stimulation.

To explicitly test whether a pair of neurons are functionally not connected, taking into account the amplitude of the response, their reliability, the number of observations and multiple hypotheses, we also computed equivalence *Peq and qeq* values. This assesses the confidence of a pair not being connected. We test whether our response is equivalent to what we would expect from our control distribution using the two one-sided t-test (TOST)72.

We computed *Peq values for ΔF/F0 and its temporal second derivative for a given pair being equivalent to the control distributions within an ε = 1.2σ. Here, σ is the standard deviation of ΔF/F0*.

We then combined the two *Peq values into a single one with the Fisher method and computed qeq values using the Storey–Tibshirani method40. Note that, different from the regular P values described above, the equivalence test relies on the arbitrary choice of ε, which defines when we call two distributions equivalent. We chose a conservative value of ε = 1.2σ*.

We note that the statistical framework is stringent and a large fraction of measured neuron pairs fail to pass either statistical test.

# Measuring path length through the synaptic network

To find the minimum path length between neurons in the anatomical network topology, we proceeded iteratively. We started from the original binary connectome and computed the map of strictly two-hop connections by looking for pairs of neurons that are not connected in the starting connectome but that are connected through a single intermediate neuron. To generate the strictly three-hop connectome, we repeated this procedure using the binary connectome including direct and two-hop connections, as the starting connectome. This process continued iteratively to generate the strictly n-hop connectome.

In the anatomical connectome, a neuron was considered to be directly anatomically connected if the connectomes of any of the four L4 or adult individuals in refs. 1 and 6 contained at least one synaptic contact between them. Note that this is a permissive description of anatomical connections.

# Kernel-based simulations of activity

Using the kernels fitted from our functional data, we can simulate neural activity without making any further assumptions about the dynamical equations of the network of neurons. To compute the response of a neuron *i to the stimulation of a neuron j*, we simply convolve the kernel.

    Page 14

k (t) with the activity ΔF(t) induced by the stimulation in neuron i,j j j. The activity of the stimulated neuron can be either the experimentally observed activity or an arbitrarily shaped activity introduced for the purposes of simulation.

To compute kernel-derived neural activity correlations (Fig. 6), we completed the following steps. (1) We computed the responses of all the neurons i to the stimulation of a neuron j chosen to drive activity in the network. To compute the responses, for each pair i, j, we used the kernel ki,j(t) averaged over multiple trials. For kernel-based trials analysis, pairs with connections of q > 0.05 were considered not connected. We set the activity ΔFj(t) in the driving neuron to mimic an empirically observed representative activity transient. (2) We computed the correlation coefficient of the resulting activities. (3) We repeated steps 1 and 2 for a set of driving neurons (all or top-n neurons, as in Fig. 6). (4) For each pair k, l, we took the average of the correlations obtained by driving the set of neurons j in step 3.

# Anatomy-derived simulations of activity

Anatomy-derived simulations were performed as described previously47. In brief, this simulation approach uses differential equations to model signal transmission through electrical and chemical synapses and includes a nonlinear equation for synaptic activation variables. We injected current in silico into individual neurons and simulated the responses of all the other neurons. Anatomy-derived responses (Fig. 3) of the connection from neuron j to neuron i were computed as the peak of the response of neuron i to the stimulation of j. Anatomy-based predictions of spontaneous correlations in Fig. 6 were calculated analogously to kernel-based predictions.

In one analysis in Fig. 3d, the synapse weights and polarities were allowed to float and were fitted from the functional measurements. In all other cases, synapse weights were taken as the scaled average of three adult connectomes1,6 and an L4 connectome, and polarities were assigned on the basis of a gene-expression analysis of ligand-gated ionotropic synaptic connections that considered glutamate, acetylcholine and GABA neurotransmitter and receptor expression, as performed in a previous study37 and taken from CeNGEN38 and other sources. Specifically, we used a previously published dataset (S1 data in ref. 37) and aggregated polarities across all members of a cellular subtype (for example, polarities from source AVAL and AVAR were combined). In cases of ambiguous polarities, connections were assumed to be excitatory, as in the previous study37. For other biophysical parameters we chose values commonly used in C. elegans modelling efforts9,30,47,73.

# Characterizing stereotypy of functional connections

To characterize the stereotypy of a neuron pair’s functional connection, its kernels were inspected. A kernel was calculated for every stimulus-response event in which both the upstream and downstream neuron exhibited activity that exceeded a threshold. At least two stimulus-response events that exceeded this threshold were required to calculate their stereotypy. The general strategy for calculating stereotypy was to convolve different kernels with the same stimulus inputs and compare the resulting outputs. The similarity of two outputs is reported as a Pearson’s correlation coefficient. Kernels corresponding to different stimulus-response events of the same pair of neurons were compared with one another round-robin style, one round-robin each for a given input stimulus. For inputs we chose the set of all stimuli delivered to the upstream neuron. The neuron-pairs stereotypy is reported as the average Pearson’s correlation coefficient across all round-robin kernel pairings and across all stimuli.

# Rise time of kernels

The rise time of kernels, shown in Fig. 5c and Extended Data Fig. 6d, was defined as the interval between the earliest time at which the value of the kernel was 1/e its peak value and the time of its peak (whether positive or negative). The rise time was zero if the peak of the kernel was at time t = 0. However, saturation of the signal transmission can make kernels appear slower than the connection actually is. For example, the simplest instantaneous connection would be represented by a single decaying exponential in equation (1), which would have its peak at time t = 0. However, if that connection is saturating, a second, opposite-sign term in the sum is needed to fit the kernel. This second term would make the kernel have a later peak, thereby masking the instantaneous nature of the connection. To account for this effect of saturation, we removed terms representing saturation from the kernels and found the rise time of these ‘non-saturating’ kernels.

# Screen for purely extrasynaptic-dependent connections

To find candidate purely extrasynaptic-dependent connections, we considered the pairs of neurons that are connected in WT animals (qWT &#x3C; 0.05) and non-connected in unc-31 animals (qunc−31 &#x3C; 0.05, with the additional condition q > 0.05 to exclude very small responses that are nonetheless significantly different from the control distribution). We list these connections and provide additional examples in Extended Data Fig. 9. Using a recent neuropeptide–GPCR interaction screen in C. elegans52 and gene-expression data from CeNGEN38, we find putative combinations of neuropeptides and GPCRs that can mediate those connections (Supplementary Table 1). We produced such a list of neuropeptide and GPCR combinations using the Python package Worm Neuro Atlas (https://github.com/francescorandi/wormneuroatlas). In the list, we only include transcripts from CeNGEN detected with the highest confidence (threshold 4), as described previously51. For each neuron pair, we first searched the CeNGEN database for neuropeptides expressed in the upstream neuron, then identified potential GPCR targets for each neuropeptide using information from previous reports52,74, and finally went back to the CeNGEN database to find whether the downstream neuron in the pair was among the neurons expressing the specific GPCRs. The existence of potential combinations of neuropeptide and GPCR putatively mediating signalling supports our observation that communication in the candidate neuron pairs that we identify can indeed be mediated extrasynaptically through neuropeptidergic machinery.

# Reporting summary

Further information on research design is available in the Nature Portfolio Reporting Summary linked to this article.

# Data availability

Machine-readable datasets containing the measurements from this work are publicly accessible through on Open Science Foundation repository at https://doi.org/10.17605/OSF.IO/E2SYT. Interactive browsable versions of the same data are available online at https://fun-conn.princeton.edu and http://funsim.princeton.edu. CeNGeN data were accessed through http://www.cengen.org/cengenapp/. Source data are provided with this paper.

# Code availability

All analysis code is publicly available at https://github.com/leiferlab/pumpprobe (https://doi.org/10.5281/zenodo.8312985), https://github.com/leiferlab/wormdatamodel (https://doi.org/10.5281/zenodo.8247252), https://github.com/leiferlab/wormneuronsegmentation-c (https://doi.org/10.5281/zenodo.8247242) and https://github.com/leiferlab/wormbrain (https://doi.org/10.5281/zenodo.8247254). Hardware acquisition code is available at https://github.com/leiferlab/pump-probe-acquisition (https://doi.org/10.5281/zenodo.8247258).

    Page 15

Article

# References

1. Noma, K. &#x26; Jin, Y. Rapid integration of multi-copy transgenes using optogenetic mutagenesis in Caenorhabditis elegans. G3 8, 2091–2097 (2018).
2. Evans, T. In WormBook https://doi.org/10.1895/wormbook.1.108.1 (2006).
3. Yu, X. et al. Fast deep neural correspondence for tracking and identifying neurons in C. elegans using semi-synthetic training. eLife 10, e66410 (2021).
4. Izquierdo, E. J. &#x26; Beer, R. D. From head to tail: a neuromechanical model of forward locomotion in Caenorhabditis elegans. Phil. Trans. R. Soc. B 373, 20170374 (2018).
5. Frooninckx, L. et al. Neuropeptide GPCRs in C. elegans. Front. Endocrinol. 3, 167 (2012).
6. Li, Z., Liu, J., Zheng, M. &#x26; Xu, X. Z. S. Encoding of both analog- and digital-like behavioral outputs by one C. elegans interneuron. Cell 159, 751–765 (2014).
7. Nguyen, J. P. et al. Whole-brain calcium imaging with cellular resolution in freely behaving Caenorhabditis elegans. Proc. Natl Acad. Sci. USA 113, E1074–E1081 (2016).
8. Venkatachalam, V. et al. Pan-neuronal imaging in roaming Caenorhabditis elegans. Natl Acad. Sci. USA 113, E1082–1088 (2016).
9. Denk, W., Strickler, J. H. &#x26; Webb, W. W. Two-photon laser scanning fluorescence microscopy. Science 248, 73–76 (1990).
10. Rickgauer, J. P. &#x26; Tank, D. W. Two-photon excitation of channelrhodopsin-2 at saturation. Proc. Natl Acad. Sci. USA 106, 15025–15030 (2009).
11. Bhatla, N. C. elegans neural network. WormWeb http://wormweb.org/neuralnet (2009).
12. Nguyen, J. P. et al. Whole-brain calcium imaging with cellular resolution in freely behaving Caenorhabditis elegans. Proc. Natl Acad. Sci. USA 113, E1074–E1081 (2015).
13. Hallinen, K. M. et al. Decoding locomotion from population neural activity in moving C. elegans. eLife 10, e66135 (2021).
14. Nguyen, J. P., Linder, A. N., Plummer, G. S., Shaevitz, J. W. &#x26; Leifer, A. M. Automatically tracking neurons in a moving and deforming brain. PLoS Comput. Biol. 13, e1005517 (2017).
15. Zhou, Z. et al. Accurate and robust non-rigid point set registration using Student’s-t mixture model with prior probability modeling. Sci. Rep. 8, 8742 (2018).
16. Papagiakoumou, E., Sars, V. D., Oron, D. &#x26; Emiliani, V. Patterned two-photon illumination by spatiotemporal shaping of ultrashort pulses. Opt. Express 16, 22039–22047 (2008).
17. Schuirmann, D. J. A comparison of the two one-sided tests procedure and the power approach for assessing the equivalence of average bioavailability. J. Pharmacokinet. Biopharm. 15, 657–680 (1987).

# Acknowledgements

We thank J. Bien, A. Falkner, F. Graf Leifer, M. Murthy, E. Naumann, H. S. Seung and J. Shaevitz for comments on the manuscript. Online visualization software and hosting was created by research computing staff in the Lewis-Sigler Institute for Integrative Genomics and the Princeton Neuroscience Institute, with particular thanks to F. Kang, R. Leach, B. Singer, S. Heinicke and L. Parsons. Research reported in this work was supported by the National Institutes of Health National Institute of Neurological Disorders and Stroke under New Innovator award number DP2-NS116768 to A.M.L.; the Simons Foundation under award SCGB 543003 to A.M.L.; the Swartz Foundation through the Swartz Fellowship for Theoretical Neuroscience to F.R.; the National Science Foundation through the Center for the Physics of Biological Function (PHY-1734030); and the Boehringer Ingelheim Fonds to S.D. Strains from this work are being distributed by the CGC, which is funded by the NIH Office of Research Infrastructure Programs (P40 OD010440).

# Author contributions

A.M.L. and F.R. conceived the investigation. F.R., S.D. and A.M.L. contributed to the design of the experiments and the analytical approach. F.R. and S.D. conducted the experiments. A.K.S. designed and performed all transgenics. F.R. designed and built the instrument and the analysis framework and pipeline. F.R. and S.D. performed the bulk of the analysis with additional contributions from A.M.L. and A.K.S. All authors wrote and reviewed the manuscript. F.R. is currently at Regeneron Pharmaceuticals. F.R. contributed to this article as an employee of Princeton University and the views expressed do not necessarily represent the views of Regeneron Pharmaceuticals.

# Competing interests

The authors declare no competing interests.

# Additional information

Supplementary information The online version contains supplementary material available at https://doi.org/10.1038/s41586-023-06683-4. Correspondence and requests for materials should be addressed to Andrew M. Leifer.

# Peer review information

Nature thanks Mei Zhen and the other, anonymous, reviewer(s) for their contribution to the peer review of this work.

Reprints and permissions information is available at http://www.nature.com/reprints.

    Page 16

# Table of Strains Used in This Work

| Strain | Genotype                                                                                                                                                                                                                                                                                   | Expression                                                                                                                           | Role                                                                              | Reference                         |
| ------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------- | --------------------------------- |
| AML320 | otIs669\[NeuroPAL] V 14x; wtfIs 145\[pBX + rab-3::his-24::GCaMP6s::unc-54]                                                                                                                                                                                                                 | NeuroPAL (Yemini et al., 2021); GCaMP6s only, no activation.                                                                         |                                                                                   | (Yu et al., 2021)                 |
| AML456 | wtfIS348 \[pAS3-5xQUAS::Δpes-10P::AI::gur-GUR-3 + PRDX-2 in 3G::unc-54 75 ng/ul + pAS3-5xQUAS::Δpes-10P::AI:prdx-2G::unc-54 75 ng/ul + pAS-3-rab-3P::AI::QF+GR::unc-54 35 ng/ul + unc-122::GFP 100 ng/ul]                                                                                  | all neurons; GFP in coelomocytes                                                                                                     | Optogenetic activator strain, used in creating AML462.                            | (Sharma et al., 2023) & this work |
| AML462 | otIs669\[NeuroPAL] V 14x; wtfIs 145\[pBX + rab-3::his-24::GCaMP6s::unc-54]; wtfIs348 \[pAS3-5xQUAS:: Δpes-10P::AI::gur-3G::unc-54 75 ng/ul + pAS3-5xQUAS::Δpes-10P::AI::prdx-2G::unc-54 75 ng/ul + pAS-3-rab-3P::AI::QF+GR::unc-54 35 ng/ul + unc-122::GFP 100ng/ul]                       | NeuroPAL (Yemini et al., 2021); GCaMP6s used for measuring signal propagation.                                                       | Primary strain in all neurons; GUR-3 + PRDX-2 in all neurons; GFP in coelomocytes | (Sharma et al., 2023) & this work |
| AML508 | unc-31 (wtf502) IV; otIs669\[NeuroPAL] V 14x; wtfIs 145 \[pBX + rab-3::his-24::GCaMP6s::unc-54]; wtfIs348 \[pAS3-5xQUAS:: Δpes-10P::AI::gur-3G::unc-54 75 ng/ul + pAS3-5xQUAS:: Δpes-10P::AI::prdx-2G::unc-54 75 ng/ul + pAS-3-rab-3P::AI::QF+GR::unc-54 35 ng/ul + unc-122::GFP 100ng/ul] | unc-31 mutant background; NeuroPAL (Yemini et al., 2021); GCaMP6s in all neurons; GUR-3 + PRDX-2 in all neurons; GFP in coelomocytes | Used for measuring signal propagation of unc-31 mutant                            | This work                         |
| AML546 | wtfEx496 \[pAS3-rig-3P: :AI::gur-3G ::SL2::tagRFP::unc-54 40ng/ul + pAS3-rig-3P::AI::prdx-2G::SL2::tagBFP::unc-54 40ng/ul]                                                                                                                                                                 | GUR-3 + PRDX-2, tagBFP and tagRFP expressed in AVA and some pharyngeal neurons (likely I1, I4, M4 and NSM)                           | Used to activate AVA and observe behavior                                         | This work                         |

# CRISPR knockout of unc-31 gene

| E1     | E2             | E3                  | E4 | E5              | E6     | E7 | E8    | E9 | E10 | E11 | E12            | E13 | E14 | E15 | E16 | E17 | E18 | E19 | E20    |
| ------ | -------------- | ------------------- | -- | --------------- | ------ | -- | ----- | -- | --- | --- | -------------- | --- | --- | --- | --- | --- | --- | --- | ------ |
| 5' UTR |                |                     |    |                 |        |    |       |    |     |     |                |     |     |     |     |     |     |     | 3'UTR  |
|        | gRNA-PAM site1 | -12476 bps & +6 bps |    |                 |        |    |       |    |     |     | gRNA-PAM site2 |     |     |     |     |     |     |     |        |
|        | 5' UTR         |                     |    | unc-31 (wtf502) | - bbps |    | Kpn-l |    |     |     |                |     |     |     |     |     |     |     | 3' UTR |

# Extended Data Fig. 1

Strains. a, Table of strains used in this work. b, Schematic of CRISPR knockout of unc-31.

    Page 17

Article

# Extended Data Fig. 2

# Characterization of two-photon optogenetic stimulation and evoked response.

# a

Two-photon (2p) stimulation spot size (point-spread function).

# b

Imaging excitation wavelength and intensity were chosen to avoid GUR-3/PRDX-2 activation. GCaMP response to 500 nm activation of GUR-3/PRDX-2 expressing neuron as reported in 24. Vertical grey line indicates light intensity typically used for calcium imaging in present work. Inset: GCaMP6 excitation spectra from 26. Vertical cyan line indicates 505-nm imaging excitation wavelength used in present work.

# c, d

A neuron near (c) and a neuron far (d) from the objective are photobleached to demonstrate targeted illumination. tagRFP-T is photobleached by 2p stim (20 s illumination, 200 μW, 500 kHz repetition rate, 3.1 μm diameter FWHM spot). Difference image shows tagRFP-T fluorescence merged with a false-colour blue-green image to reveal change in intensity after targeted illumination. Only targeted neuron and not nearby neurons appear photobleached. Insets shows zoomed-in image of the targeted neuron’s original tagRFP-T intensity (left) and difference image (right).

Laser power was chosen to avoid saturated bleaching. For a sense of scale, C. elegans interneuron cell somas are roughly 4 microns in diameter.

# e

In vivo demonstration of 2p effective spot size. Activity from a neuron expressing GUR-3/PRDX-2 and GCaMP6s is shown in response to a 300-ms 2p stimulation delivered at t= 11 s, 4 μm beyond the ≈ 3.5 μm diameter soma on the optical axis (z), and at t= 35 s, centred on the soma (t= 35 s). Only on-target soma stimulation evokes a transient, called an “autoresponse”. A stimulus artefact at t= 35 s is visible because no smoothing or filtering is applied to this trace. Schematic via BioRender.

# f

Distribution of autoresponses under typical stimulus conditions (1.2 mW, 500 kHz; 0.5 s for WT, 0.3 s for unc-31). Autoresponses are required for inclusion.

# g

Measured calcium response of neuron AIY to optogenetic stimulation of AFD. Compare to figure 4b in ref. 48. A variety of stimulus durations was used to generate autoresponses of different amplitudes (n = 1 (0.1 s), n = 2 (0.15 s), n = 1 (0.2 s), n = 3 (0.25 s), n = 3 (0.3 s), n = 3 (0.35 s), n = 6 (0.4 s), n = 2 (0.45 s), n = 4 (0.5 s); cross-hairs indicate s.d.

# h

Blue light evoked more reversals in animals expressing GUR-3/PRDX-2 in AVA (n = 11 animals) than WT (n = 8 animals). ~480 nm peaked light was delivered to freely moving animals. Unpaired t-test, p = 0.025. Bars show mean and s.d.

# i, j

Probability density (i) and CDF (j) of evoked calcium responses in a 30-s post-stimulus window for the targeted neuron (0 μm) or for neurons different distances away. Autoresponses are required. Cross-hairs in j, 75% cumulative distribution at ΔF/F₀ = 0.1.

    Page 18

# Extended Data Fig. 3

# Signal propagation map.

a, Mean amplitude of neural activity in a post-stimulus time window (ΔF/F0) averaged across trials and individuals for WT background. White indicates no measurement. (n = 113 animals) For a measurement to be included, a stimulus event is required to evoke a response in the stimulated neuron. Same measurements as in Fig. 2a, but here all neurons that respond are shown, even if they are never stimulated.

|   | stimulated | observed in n datasets | stimulated n times |
| - | ---------- | ---------------------- | ------------------ |
| a | 100        | 80                     | 60                 |
|   | 40         | 20                     | 6                  |
|   | 8          |                        |                    |

b, Number of stimulation events (orange) and number of datasets (animals) in which the neuron was observed (blue) for each neuron is shown.

    Page 19

Article

# Extended Data Fig. 4

Observations and false discovery rate of neuron pairs in the signal propagation map.

# a

Number of observations made of each neuron pair for WT-background animals. To be considered an observation, the upstream neuron must have been stimulated, calcium imaging of both the upstream and downstream neuron must have been recorded, both neurons must have been unambiguously identified and the upstream neuron must have exhibited an autoresponse. Sorted as in Extended Data Fig. 3a. Reverse cumulative distribution is also shown (bottom) and reports the fraction of pairs (number of observed pairs divided by the total number of possible pairs of neurons in the head).

| a          | Number of Observations | b    | q-Values |
| ---------- | ---------------------- | ---- | -------- |
| -0.6       | 50                     | -0.5 | 2        |
| 402020     | -0.40                  | 30   | 0.3      |
| -0.2       | 10                     | -0.1 | -0.0     |
| stimulated | stimulated             | 1.0  | 37111    |
| 201.0      | 2459820                | 2020 | 18556    |
| 20         | D                      | 0.5  | 12299    |
| 0.0        | 0                      | 0    | 30       |
| 60         | 0.00.00                | 0.25 | 0.50     |

# b

q values are shown for each neuron pair. q values report the false discovery rate of finding a functional connection. They provide a metric of significance for assessing whether a neuron pair is functionally connected based on the number of observations and the magnitude of the response transients, taking into consideration the number of multiple hypotheses tested. Cumulative distribution is also shown (bottom).

# c

ASGR often exhibits activity immediately following stimulation of AVJR, but because its q value is greater than 0.05, it does not meet the stringent statistical threshold to be deemed “functionally connected”. Top: mean (blue) and s.d. (shading) across trials and animals.

    Page 20

# Extended Data Fig. 5

Signal propagation map showing false discovery rates for functional connections and non-connections. a, Map of functional connections showing downstream calcium response amplitude and false discovery rate for WT. Same as Fig. 2 except here neurons that are observed but not stimulated are also included. Note the colour bar has two axes. Mean amplitude of neural activity in a post-stimulus time window (ΔF/F0) averaged across trials and individuals is shown. q value reports false discovery rate (more grey is less significant). White indicates no measurement. Autoresponse is required for inclusion and not displayed (black diagonal). (n = 113 animals).

|   | q value                                                                                                               |
| - | --------------------------------------------------------------------------------------------------------------------- |
| a | 0.5	0.4	0.3	0.2	0.1	0.0	-0.1	-0.2	-0.3	-0.4&#xA;0.35	0.30	-0.25	0.20	0.15	No measurement	Not Displayed	0.10	0.05	0.00 |

b
stimulated

    Page 21

Article

# Responses / Observations

# AQR → FLPR

|          | AQR (Stim) | Time (s) | FLPR (Resp) |
| -------- | ---------- | -------- | ----------- |
| 0.620    | DAf₁       | 1        |             |
| 0        | 0          | -10      | 0           |
| 10       | 20         | 30       | -10         |
| 0        | 10         | 20       | 30          |
| 0.4      | 20         |          | 0           |
| 0.2      | 10         |          | -!          |
| No       | 11         | 12       | measurement |
| Not      | 13         | 14       | Displayed   |
| 0.0      | 17         | 18       | 10          |
| 20       | -10        | 20       |             |
| Time (s) |            |          |             |

# Kernel Rise Time

# Stereotypy of Kernels

| 2.0   | 1.00  |
| ----- | ----- |
| -0.75 |       |
| 1.5   | -0.50 |
| 20    | 1.020 |
| 20    | 0.25  |
| 20    | 0.00  |
| -0.25 |       |
| 0.5   | -0.50 |
| -0.75 |       |

Stimulated No 0.6

measurement

Not

Displayed

Responses generated from the same pair of neurons

All generated responses shuffled

| 1.5 | 0.0 | -1.0 | -0.5 | 0.0 | 0.5 | 1.0 |
| --- | --- | ---- | ---- | --- | --- | --- |

# Extended Data Fig. 6

Timescales and variability of measured functional connectivity. WT. a, The fraction of stimulation events that evoked a downstream “response” is shown for each neuron pair. To be classified as a “response” requires a sufficiently large calcium transient amplitude and derivative. Autoresponses are required and not shown (black diagonal).

b, Kernels are functions that return the downstream neuron’s activity when convolved with the upstream neuron’s activity. Kernels capture properties of the connection independent of variability in the upstream neuron’s autoresponse.

c, Kernels are shown for each FLP response to AQR stimulation. Kernels are only calculated for stimuli that evoked downstream ‘responses’ (indicated in orange). Top: mean (blue) and s.d. (shading) across trials and animals.

d, Kernel rise time for each measured neuron pair in WT is a metric of signal propagation speed.

e, The stereotypy of kernels within each neuron pair is reported by calculating the average correlation coefficient among them. Only neuron pairs with at least two kernels are considered.

f, Distribution of the correlation-coefficients of convolved kernels, within each pair of neurons (blue, n = 30,406), and across all kernels measured regardless of neuron pair (orange, n = 113,880,912).

    Page 22

# Extended Data Fig. 7

Signal propagation of the unc-31 background, with defects in dense-core-vesicle-mediated extrasynaptic signalling.

a, Same format as Extended Data Fig. 5a. Mean amplitude of neural activity in a post-stimulus time window (ΔF/F0) averaged across trials and individuals is shown. Neurons with the smallest amplitude responses are not shown. Corresponding traces for ADLR, AWBR and URXL are shown in Fig. 4. As in that figure, responses here are shown even for those cases when RID’s calcium activity was not measured and therefore do not appear in a measurement.

q value reports false discovery rate and is a metric of significance (more grey is less significant). White indicates no measurement. Autoresponse is required and not displayed (black diagonal). (n = 18 animals).

b, unc-31 mutants had a smaller proportion of measured pairwise neurons that were functionally connected (q &#x3C; 0.05) than WT (considering only those pairs for which data is present in both WT and unc-31 mutants).

c, Responses to RID stimulation are shown for WT (blue) and unc-31 (orange). Points are responses, bar is mean across trials and animals.

| a         | 0.4          | b                 |
| --------- | ------------ | ----------------- |
|           | 20           |                   |
| 0.3       | 20           | 0.075             |
|           |              | 0.050             |
| 0.2       |              | 0.025             |
|           |              | 0.000             |
| WT unc-31 |              |                   |
| 0.1       |              |                   |
| 20        | -0.0         |                   |
|           | -0.1         |                   |
| -0.2      |              |                   |
| -0.3      |              |                   |
|           | <-0.4        |                   |
| >0.5      | 0.0          | q value           |
| No        | measurement  | Not               |
| displayed |              |                   |
| C         | 1.0          | stimulated        |
| DAT       | 0.5          | 0.0               |
| -0.5      |              |                   |
| A         | A            | A                 |
| SE        | 0            |                   |
| MMATAMA   | CAAMMN ASATA | Ss0MMNMAT WITMMTC |
| B         | 0            | 0                 |
| B         | 2            | m                 |
| 0         | N8S0XIEX18   | T VIE0MADA1N      |
| SA00010   | 10           | A                 |

    Page 23

Article

# 1. WT unc-31

| A¹    | AWBR (Stim) | AWBL (Resp) | AWBR (Stim) | AWBL (Resp) |    |
| ----- | ----------- | ----------- | ----------- | ----------- | -- |
| 1     | 1           | 1           | > 1.2       |             |    |
| 0     | 0           | 0           | 0           |             |    |
| -10   | 0           | 10          | 20          | 30          |    |
| -10   | 0           | 10          | 20          | 30          |    |
| > 1.2 | 201¹        | < -1.2      | 2           |             |    |
| 1     | 3           | 2           | 20          | 30          |    |
|       | 3           | -10         | 0           | 10          | 30 |
| 4     | Time (s)    | Time (s)    |             |             |    |

# 2. I3 (Stim) and M1 (Resp)

| A²  | I3 (Stim) | 2        | M1 (Resp) | Ar¹ | > 1.2 |
| --- | --------- | -------- | --------- | --- | ----- |
| 1   | 1         | 0        | 0         |     |       |
| 0   | 0         | > 1.2    | -10       | 0   | 10    |
| 20  | 30        | -10      | 0         | 10  | 20    |
| 30  | 2S¹       | < -1.2   | 20        | -0  | 2     |
| 20S | < -1.2    | Time (s) | Time (s)  |     |       |

# 3. RMDL (Stim) and AVEL (Resp)

| r1.0  | RMDL (Stim) | 1.0    | AVEL (Resp) | r        | RMDL (Stim) | 1  | AVEL (Resp) | > 1.2 |
| ----- | ----------- | ------ | ----------- | -------- | ----------- | -- | ----------- | ----- |
| 0.5   |             | 0.5    |             | > 1.2    | 0           |    |             |       |
| 0.0   |             | 0.0    |             | -10      | 0           | 10 | 20          | 30    |
| -10   | 0           | 10     | 20          | 30       | -10         | 0  | 10          | 20    |
| 30    | 20S¹        |        | < -1.2      | -0       | 2           | 3  |             |       |
| 20S20 |             | < -1.2 | Time (s)    | Time (s) |             |    |             |       |

# 4. SAAVR (Stim) and AVAR (Resp)

| d   | Time (s) | Time (s) | SAAVR (Stim) | AVEL (Resp) | SAAVR (Stim) | AVEL (Resp) | > 1.2 |
| --- | -------- | -------- | ------------ | ----------- | ------------ | ----------- | ----- |
| 1   |          |          |              | > 1.2       | AT₀          | 1           | > 1.2 |
|     | -10      | 0        | 10           | 20          | 30           | -10         | 0     |
| 10  | 20       | 30       | -0           | 0           | 1            | < -1.2      | 3     |
| 20T |          | < -1.2   | -10          | 0           | 10           | 20          | 30    |
| 4   |          | Time (s) | Time (s)     |             |              |             |       |

Extended Data Fig. 8 | Neural responses for some pairs are similar in WT and unc-31-mutant animals. Paired stimulus and response traces of selected neuron pairs with monosynaptic gap junctions (a–c) or monosynaptic chemical synapses (d) are shown in a WT background (left) and in a unc-31 mutant background (right). Top: mean (blue) and s.d. (shading) across trials and animals.

    Page 24

# Extended Data Fig. 9

# Examples of candidate purely extrasynaptic pairs.

compiled from refs. 38,52, following ref. 51.

c–e, Paired responses in WT and

a, Change in activity Δ⟨ΔF/F⟩ versus number of WT observations for our unc-31 animals for the candidate extrasynaptic pairs AVER–RMDDR (c), AVDR–ASHR (d) and RMDDR–RMDDL (e), selected among all the candidates as illustrated in a.

b, List of candidate entirely extrasynaptic-dependent connections. Arrows indicate examples of candidate purely extrasynaptic-dependent pairs.

|     | AVER (Stim) |     | WT RMDDR (Resp) |     |     | d AVDR (Stim) | WT ASHR (Resp) |     | e RMDDR (Stim) | WT RMDDL (Resp) |
| --- | ----------- | --- | --------------- | --- | --- | ------------- | -------------- | --- | -------------- | --------------- |
| 1.0 | 1.0         | 1.0 | 1.0             | 1.0 | 1.0 |               |                |     |                |                 |
|     |             |     | 0.5             | 0.5 | 0.5 | 0.5           | 0.5            | 0.5 |                |                 |
|     | 0.0         | 0.0 | 0.0             | 0.0 | 0.0 | 0.0           |                |     |                |                 |

Relevant neuropeptide GPCR expression is listed in Supplementary Table 1.

    Page 25

# Article

# Extended Data Table 1

# Selected instances of agreement between measured signal propagation and previously reported functional measurements

| Claim                                                             | Evidence                                                                                                                              | Reference                                                          | Figure    | Finding                                                                         | Figure                               |
| ----------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------ | --------- | ------------------------------------------------------------------------------- | ------------------------------------ |
| Activation of ASH excites AVA                                     | Paired optogenetic activation (ChR2) and electrophysiology (whole cell patch clamp)                                                   | Lindsay et al., 2011 <https://doi.org/10.1038/ncomms1304>          | Fig 4     | ASHR->AVAR is functionally connected (q<0.05) and excitatory                    | Fig 2a; Extended Data 4b             |
| Paired optogenetic stimulation (ChR2) and calcium imaging (GCaMP) | Guo et al., 2009 <https://doi.org/10.1038/nmeth.1397>                                                                                 | Fig 5                                                              |           |                                                                                 |                                      |
| Activation of ASH excites AVD                                     | Paired optogenetic stimulation (ChR2) and calcium imaging (GCaMP)                                                                     | Guo et al., 2009 <https://doi.org/10.1038/nmeth.1397>              | Fig 5     | ASHL->AVDL is functionally connected (q<0.05) and excitatory                    | Fig 2a; Extended Data Fig 4b         |
| Activation of AFD excites AIY and has a linear response           | Paired optogenetic stimulation (ChR2) and electrophysiology (whole cell patch clamp)                                                  | Narayan et al., 2011 <https://doi.org/10.1073/pnas.1106617108>     | Fig 4     | AFD excites AIY and has a linear response                                       | Extended Data Fig 2g                 |
| AVA and AVE can be treated as a single functional unit            | AVA and AVE are imaged as a single region of interest during calcium imaging and they yield behaviorally relevant calcium transients; | Kawano et al., 2011 <https://doi.org/10.1016/j.neuron.2011,09.005> | Fig 1c,d  | AVA and AVE have reciprocal functional connections (q<0.05) that are excitatory | Fig 1f; Fig 2a; Extended Data Fig 4b |
|                                                                   | AVA's and AVE's calcium activity respond similarly to changes in oxygen and have similar tuning to velocity                           | Kato et al., 2015 <https://doi.org/10.1016/j.cell.2015.09.034>     | Fig S7g-p |                                                                                 |                                      |

# Comparisons between selected findings from the literature and the current work.

    Page 26

nature portfolio
Corresponding author(s): Andrew Leifer

Last updated by author(s): 4/10/2023

# Reporting Summary

Nature Portfolio wishes to improve the reproducibility of the work that we publish. This form provides structure for consistency and transparency in reporting. For further information on Nature Portfolio policies, see our Editorial Policies and the Editorial Policy Checklist.

# Statistics

For all statistical analyses, confirm that the following items are present in the figure legend, table legend, main text, or Methods section.

- n/a Confirmed
- The exact sample size (n) for each experimental group/condition, given as a discrete number and unit of measurement
- A statement on whether measurements were taken from distinct samples or whether the same sample was measured repeatedly
- The statistical test(s) used AND whether they are one- or two-sided
- Only common tests should be described solely by name; describe more complex techniques in the Methods section.
- A description of all covariates tested
- A description of any assumptions or corrections, such as tests of normality and adjustment for multiple comparisons
- A full description of the statistical parameters including central tendency (e.g. means) or other basic estimates (e.g. regression coefficient) AND variation (e.g. standard deviation) or associated estimates of uncertainty (e.g. confidence intervals)
- For null hypothesis testing, the test statistic (e.g. F, t, r) with confidence intervals, effect sizes, degrees of freedom and P value noted
- Give P values as exact values whenever suitable.
- For Bayesian analysis, information on the choice of priors and Markov chain Monte Carlo settings
- For hierarchical and complex designs, identification of the appropriate level for tests and full reporting of outcomes
- Estimates of effect sizes (e.g. Cohen's d, Pearson's r), indicating how they were calculated

Our web collection on statistics for biologists contains articles on many of the points above.

# Software and code

Policy information about availability of computer code

# Data collection

Software to control acquisition hardware is available at https://github.com/leiferlab/pump-probe

# Data analysis

All analysis code is publicly available at https://github.com/leiferlab/pumpprobe (DOI:10.5281/zenodo.8247256), https://github.com/leiferlab/wormdatamodel (DOI:10.5281/zenodo.8247252), https://github.com/leiferlab/wormneuronsegmentation-c (DOI:10.5281/zenodo.8247242), and https://github.com/leiferlab/wormbrain (DOI:10.5281/zenodo.8247254). Hardware acquisition code is available at https://github.com/leiferlab/pump-probe-acquisition (DOI:10.5281/zenodo.8247258).

For manuscripts utilizing custom algorithms or software that are central to the research but not yet described in published literature, software must be made available to editors and reviewers. We strongly encourage code deposition in a community repository (e.g. GitHub). See the Nature Portfolio guidelines for submitting code &#x26; software for further information.

# reporting summary

\| nature portfolio

March 2021

1

    Page 27

# Data

# Policy information about availability of data

All manuscripts must include a data availability statement. This statement should provide the following information, where applicable:

- Accession codes, unique identifiers, or web links for publicly available datasets
- A description of any restrictions on data availability
- For clinical datasets or third party data, please ensure that the statement adheres to our policy

Machine readable datasets containing the measurements from this work are publicly accessible through on Open Science Foundation repository at https://doi.org/10.17605/OSF.IO/E2SYT. Interactive browseable versions of this same data are available online at https://funconn.princeton.edu and http://funsim.princeton.edu. CeNGeN data was accessed through http://www.cengen.org/cengenapp/.

# Human research participants

# Policy information about studies involving human research participants and Sex and Gender in Research.

- Reporting on sex and gender: N/A
- Population characteristics: N/A
- Recruitment: N/A
- Ethics oversight: N/A

Note that full information on the approval of the study protocol must also be provided in the manuscript.

# Field-specific reporting

Please select the one below that is the best fit for your research. If you are not sure, read the appropriate sections before making your selection.

- Life sciences
- Behavioural &#x26; social sciences
- Ecological, evolutionary &#x26; environmental sciences

For a reference copy of the document with all sections, see nature.com/documents/nr-reporting-summary-flat.pdf

# Life sciences study design

All studies must disclose on these points even when the disclosure is negative.

- Sample size: No sample-size calculation was performed. We recorded from >113 individual WT-background animals and performed over 20,000 pairwise stimulus response measurements. Sample size was chosen to be many fold larger than typical C. elegans calcium imaging experiments in the field, e.g. Hallinen et al., elife 2021.
- Data exclusions: Inclusion and exclusion criteria are described in the "Inclusion criteria" subsection of the Methods, and pasted here: Stimulation events were included for further analysis if they evoked a detectable calcium response in the stimulated neuron (autoresponse). A classifier determined whether the response was detected by inspecting whether the amplitude of both the DF/F transient and its second derivative exceeded a pair of thresholds. The same threshold values were applied to every animal, strain, neuron and stimulation event, and were originally set to match human perception of a response above noise. Stimulation events that did not meet both thresholds for a contiguous 4 seconds were excluded. RID responses shown in Fig. 4 and Extended Data Fig. 7c are an exception to this policy. RID is visible based on its CyOFP expression, but its tagRFP-T expression is too dim to consistently extract calcium signals. Therefore in Fig. 4 and Extended Data Fig. 7c (but not in other figures, like Fig. 2) responses to RID stimulation were included even in cases where it was not possible to extract a calcium-activity trace in RID.
- Neuron traces were excluded from analysis if a human was unable to assign an identity or if the imaging time points were absent in a contiguous segment longer than 5% of the response window due to imaging artifacts or tracking errors. A different policy applies to dim neurons of interest that are not automatically detected by the "pseudo"-segmentation algorithm in the 3D image used as reference for the pointset registration algorithm. In those cases, we manually added the position of those neurons to the reference 3D image. If these "added" neurons are automatically detected in most of the other 3D images, then a calcium activity trace can be successfully produced by the DSMM nonrigid registration algorithm and is treated as any other trace. However, if the "added" neurons are too dim to be detected also in the other 3D images and the calcium activity trace cannot be formed for more than 50% of the total time points, the activity trace for those neurons is extracted from the neuron's position as determined from the position of neighboring neurons. In the analysis code, we refer to these as "matchless" traces, because the reference neuron is not matched to any detected neuron in the specific 3D image, but its position is just transformed according to the DSMM nonrigid deformation field. In this way, we are able to recover the calcium activity also of some neurons whose tag-RFP-T expression is otherwise too dim to be reliably detected by the "pseudo"-segmentation algorithm. Responses to RID stimulation shown in Fig. 4 and Extended Data Fig. 7c are an exception to this policy. There, the activity of any neuron for which there is not a trace for more than 50% of the time points is substituted with the corresponding "matchless" trace, and not just for the manually added neurons. This is important to be able to show responses of neurons like ADL, which have dim tagRFP-T expression. In the RID-specific case, in

# reporting summary

\| nature portfolio

March 2021

    Page 28

In order to exclude responses that become very large solely because of numerical issues in the division by the baseline activity due to the dim tagRFP-T, we additionally introduce a threshold excluding DF/F>2.

Kernels were computed only for stimulation-response events for which the automatic classifier detected responses in both the stimulated and downstream neurons. If the downstream neuron did not show a response, we considered the downstream response to be below the noise level and the kernel to be zero.

# Replication

The number of replications for each WT measurement is presented in Supplementary Figure S5a, and additional related information is presented in Supplementary Figure S6.

# Randomization

Randomization was not relevant to our study because we are not testing an intervention on individuals, but instead mapping out signal propagation in WT and mutant animals.

# Blinding

Humans were blinded to calcium activity when they assigned neurons their identities. An exception is neuron AIY in experiments associated with Supplementary Fig S11. Because AIY's identity is sometimes ambiguous based on its position and color, calcium activity was occasionally used to confirm AIY's identity.

# Reporting for specific materials, systems and methods

We require information from authors about some types of materials, experimental systems and methods used in many studies. Here, indicate whether each material, system or method listed is relevant to your study. If you are not sure if a list item applies to your research, read the appropriate section before selecting a response.

| Materials & experimental systems | Methods                |
| -------------------------------- | ---------------------- |
| n/a                              | Involved in the study  |
| Antibodies                       | ChIP-seq               |
| Eukaryotic cell lines            | Flow cytometry         |
| Palaeontology and archaeology    | MRI-based neuroimaging |
| Animals and other organisms      |                        |
| Clinical data                    |                        |
| Dual use research of concern     |                        |

# Animals and other research organisms

Policy information about studies involving animals; ARRIVE guidelines recommended for reporting animal research, and Sex and Gender in Research.

| Laboratory animals      | C. elegans. Strains used include AML462 and AML508 as described in the "Strains" section of the Materials and Methods.                                                                                        |
| ----------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Wild animals            | Only laboratory strains were used.                                                                                                                                                                            |
| Reporting on sex        | Hermaphrodites were studied because >99.8% of naturally occurring C. elegans are hermaphrodites (Corsi, et al., WormBook 2015)                                                                                |
| Field-collected samples | N/A                                                                                                                                                                                                           |
| Ethics oversight        | No ethical approval or guidance was required because C. elegans are microscopic invertebrate worms. Note that full information on the approval of the study protocol must also be provided in the manuscript. |

# reporting summary

\| nature portfolio

March 2021
